---
title: "Grand Canyon QAQC for FMH Data"
author: "Alexandra Lalor"
output:
  html_document:
    theme: readable
    highlight: 
    toc: yes
    toc_depth: 3
    toc_float:
      smooth_scroll: yes
    code_download: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

# BEFORE STARTING

### Install Packages (if needed)

```{r}
# install.packages("tidyverse")
# install.packages("Rtools")
# install.packages("janitor")
# install.packages("condformat")
# install.packages("knitr")
# install.packages("here")
```

### Load Packages

```{r}
# tidyverse and dplyr have lots of useful functions for data cleaning
library(tidyverse)
library(dplyr)
library(plyr)
# janitor has functions to find duplicates
library(janitor)
# EnvStats is needed for the rosnerTest() function
library(EnvStats)
# writexl is used to create excel output files
library(writexl)
# condformat is used to format excel output files
library(condformat)
# knitr is used to create output files from R Markdown
library(knitr)
# here is useful for easily finding the working directory of any project
library(here)
```

### Create Function

```{r}
# Blank data frame
errors_blank <- data.frame("SavedQuery" = "","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

# QAQC function
qaqc <- function(data, query, query_message, values_check) {
  
  # Check if there is data to QAQC
  if(nrow(data) == 0) {
  # If there is no data, default to "No Error" data frame
  errors <- errors_blank %>%
    mutate(SavedQuery = query,
           Error = "No Error")
  # If there is data, perform error check
} else {
  
  # Use relevant dataset to look for errors
  errors <- data %>%  
    # Add columns relevant to error checking
           # Populate the "SavedQuery" column with the query name
    mutate("SavedQuery" = query, 
           # Populate the "Error" column with the query message and relevant data
           "Error" = paste(query_message, "=", values_data),
           # Create a blank "Fixed" column
           "Fixed" = "",
           # Create a blank "Explanation" column
           "Explanation" = "",
           # Create a blank "Queryers" column
           "Queryers" = "") %>%   
    # Filter for data which is "false" (data does not match valid conditions)
    # NA values are treated as "false" (missing data is not valid)
    filter(!(values_check %>% replace_na(FALSE))) %>%   
    # Select relevant columns to view errors
    select("SavedQuery","MacroPlot.Name","Date","Error", "Fixed", "Explanation", "Queryers")
  
  # Next, check if there are duplicate errors
  errors_temp <- errors %>% 
    get_dupes(SavedQuery,MacroPlot.Name, Date, Error)
  # Merge duplicate errors
  errors <- unique(merge(errors, errors_temp, all = T))
  # If duplicate errors exist, add number of duplicates to error message
  errors <- errors %>% 
    mutate(Error = ifelse(is.na(dupe_count), Error, paste0("(x", dupe_count, ") ", Error))) %>% 
    select(!"dupe_count")
}
  
  # Check if there are no errors
  if (nrow(errors) == 0) {  
    # If there are no errors, default to "No Error" data frame
    errors <- errors_blank %>%
      mutate(SavedQuery = query,
             Error = "No Error")
    # If there are errors, keep error log you just created
  } else {   
    errors <- errors
  }
}
```

### Adjust File Paths

Make sure to update file paths to be specific for your data.

```{r}
# Identify working directory.
here()

# Load in data.
path_data <- "X:/FFI Data Management/Exports from FFI/GRCA_FMH/2025-01-23/"
path_errors <- paste0(here(), "/output/errors/")
path_errors_name <- "2023 GRCA FMH PIED QAQC Errors"
```

### Load Data

```{r}
# Load in data
Fuels1000_all <- read.csv(paste0(path_data, "Surface Fuels - 1000Hr_XPT.csv"), quote = "")
FuelsDuffLitt_all <- read.csv(paste0(path_data, "Surface Fuels - Duff_Litter_XPT.csv"), quote = "")
FuelsFine_all <- read.csv(paste0(path_data, "Surface Fuels - Fine_XPT.csv"), quote = "")
PostBurn_all <- read.csv(paste0(path_data, "Post Burn Severity_XPT.csv"), quote = "")
Trees_all <- read.csv(paste0(path_data, "Trees - Individuals (metric)_XPT.csv"), quote = "")
Seedlings_all <- read.csv(paste0(path_data, "Density - Quadrats (metric)_XPT.csv"), quote = "")
Shrubs_all <- read.csv(paste0(path_data, "Density - Belts (metric)_XPT.csv"), quote = "")
HerbsObs_all <- read.csv(paste0(path_data, "Cover - Species Composition (metric)_XPT.csv"), quote = "")
HerbsPoints_all <- read.csv(paste0(path_data, "Cover - Points (metric)_XPT.csv"), quote = "")
```

### Clean Data

```{r}
#####
# Fuels1000
#####
# Reformat date column
Fuels1000_all <- Fuels1000_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# FuelsDuffLitt
#####
# Reformat date column
FuelsDuffLitt_all <- FuelsDuffLitt_all %>%  
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# FuelsFine
#####
# Reformat date column
FuelsFine_all <- FuelsFine_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# PostBurn
#####
# Reformat date column
PostBurn_all <- PostBurn_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# Trees
#####
# Reformat date column
Trees_all <- Trees_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))


#####
# Seedlings
#####
# Reformat date column
Seedlings_all <- Seedlings_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# Shrubs
#####
# Reformat date column
Shrubs_all <- Shrubs_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# HerbsObs
#####
# Reformat date column
HerbsObs_all <- HerbsObs_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))

#####
# HerbsPoints
#####
# Reformat date column
HerbsPoints_all <- HerbsPoints_all %>%
  # Separate Date column
  separate(Date, sep = " ", into = c("Date", "Time")) %>%
  separate(Date, sep = "/", into = c("Month", "Day", "Year"), remove = FALSE) %>%
  # Reformat Date column
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>%
  # Remove Month, Day, and Time columns
  select(!c("Month", "Day", "Time"))
```

### Filter Data

```{r}
#####
# Fuels1000
#####
# Ensure blanks in Visited column are NA
Fuels1000_all$Visited[Fuels1000_all$Visited==""] <- NA
# Fuels1000 data
Fuels1000_data <- Fuels1000_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# Fuels1000 headers
Fuels1000_header <- Fuels1000_all %>%
  filter(!is.na(Visited), Year %in% c(2024))

#####
# FuelsDuffLitt
#####
# Ensure blanks in Visited column are NA 
FuelsDuffLitt_all$Visited[FuelsDuffLitt_all$Visited==""] <- NA 
# FuelsDuffLitt data
FuelsDuffLitt_data <- FuelsDuffLitt_all %>%   
  filter(is.na(Visited), Year %in% c(2024))  
# FuelsDuffLitt headers 
FuelsDuffLitt_header <- FuelsDuffLitt_all %>%   
  filter(!is.na(Visited), Year %in% c(2024))

#####
# FuelsFine
#####
# Ensure blanks in Visited column are NA 
FuelsFine_all$Visited[FuelsFine_all$Visited==""] <- NA  
# FuelsFine data
FuelsFine_data <- FuelsFine_all %>%   
  filter(is.na(Visited), Year %in% c(2024))  
# FuelsFine headers 
FuelsFine_header <- FuelsFine_all %>%   
  filter(!is.na(Visited), Year %in% c(2024))

#####
# PostBurn
#####
# Ensure blanks in Visited column are NA
PostBurn_all$Visited[PostBurn_all$Visited==""] <- NA
# PostBurn data
PostBurn_data <- PostBurn_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# PostBurn headers
PostBurn_header <- PostBurn_all %>%
  filter(!is.na(Visited), Year %in% c(2024))

#####
# Trees
#####
# Ensure blanks in Visited column are NA 
Trees_all$Visited[Trees_all$Visited==""] <- NA  
# Trees data
Trees_data <- Trees_all %>%   
  filter(is.na(Visited), Year %in% c(2023), MacroPlot.Purpose %in%  c("PIED"))  
# Trees headers
Trees_header <- Trees_all %>%   
  filter(!is.na(Visited), Year %in% c(2023), MacroPlot.Purpose %in%  c("PIED"))

#####
# Seedlings
#####
# Ensure blanks in Visited column are NA
Seedlings_all$Visited[Seedlings_all$Visited==""] <- NA
# Seedlings data
Seedlings_data <- Seedlings_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# Seedlings headers
Seedlings_header <- Seedlings_all %>%
  filter(!is.na(Visited), Year %in% c(2024))

#####
# Shrubs
#####
# Ensure blanks in Visited column are NA
Shrubs_all$Visited[Shrubs_all$Visited==""] <- NA
# Shrubs data
Shrubs_data <- Shrubs_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# Shrubs headers
Shrubs_header <- Shrubs_all %>%
  filter(!is.na(Visited), Year %in% c(2024))

#####
# HerbsObs
#####
# Ensure blanks in Visited column are NA
HerbsObs_all$Visited[HerbsObs_all$Visited==""] <- NA
# HerbsObs data
HerbsObs_data <- HerbsObs_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# HerbsObs headers
HerbsObs_header <- HerbsObs_all %>%
  filter(!is.na(Visited), Year %in% c(2024))

#####
# HerbsPoints
#####
# Ensure blanks in Visited column are NA
HerbsPoints_all$Visited[HerbsPoints_all$Visited==""] <- NA
# HerbsPoints data
HerbsPoints_data <- HerbsPoints_all %>%
  filter(is.na(Visited), Year %in% c(2024))
# HerbsPoints headers
HerbsPoints_header <- HerbsPoints_all %>%
  filter(!is.na(Visited), Year %in% c(2024))
```

# PROTOCOL - SURFACE FUELS

## 1000HR (CWD)

This code conducts quality control checks on coarse woody debris (CWD) surface fuels data within the "Surface Fuels - 1000Hr" data set.

It checks for errors in: headers, decay class values, diameters, fuel constants, duplicates, slope, and transects.

### Fuel 1000 Complete

[Problem:]{.underline} Extra or missing data points in FMH plots. Plots with no course woody debris should be verified.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits \> 0

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- Fuels1000_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- Fuels1000_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(Fuels1000_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Fuel 1000 Complete" 
query_message <- "CWD" 
values_data <- data$sum_hits
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_Fuels1000_Complete <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Check that NumTran = 4

```{r}
# Set parameters 
data <- Fuels1000_header
query <- "Fuel 1000 Header"
query_message <- "Number of Transects" 
values_data <- data$NumTran
values_valid <- 4
values_check <- values_data == values_valid

# Identify errors
errors_Fuels1000_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that North Rim TranLen = 50 (or very close). North Rim plots include PIAB, PIEN, and PIPN.

```{r}
# Set parameters 
data <- Fuels1000_header %>% 
  filter(MacroPlot.Purpose %in% c("PIAB", "PIEN", "PIPN"))
query <- "Fuel 1000 Header" 
query_message <- "NRim Transect Length" 
values_data <- data$TranLen 
values_valid <- 50  
values_check <-values_data == values_valid

# Identify errors
errors_Fuels1000_TranLen_N <- qaqc(data, query, query_message, values_check)
```

-   Check that South Rim TranLen = 100 (or very close). South Rim plots include PIED and PIPO.

```{r}
# Set parameters 
data <- Fuels1000_header %>% 
  filter(MacroPlot.Purpose %in% c("PIED", "PIPO"))
query <- "Fuel 1000 Header" 
query_message <- "SRim Transect Length" 
values_data <- data$TranLen 
values_valid <- 100 
values_check <- values_data == values_valid

# Identify errors
errors_Fuels1000_TranLen_S <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Fuels1000_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Fuel 1000 Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Fuels1000_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Fuels1000_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Fuel 1000 Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Fuels1000_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
# Combine
errors_Fuels1000_Header <- unique(rbind(errors_Fuels1000_NumTran, errors_Fuels1000_TranLen_N, errors_Fuels1000_TranLen_S, errors_Fuels1000_FieldTeam, errors_Fuels1000_EntryTeam))

remove(errors_Fuels1000_NumTran, errors_Fuels1000_TranLen_N, errors_Fuels1000_TranLen_S, errors_Fuels1000_FieldTeam, errors_Fuels1000_EntryTeam)

if(nrow(errors_Fuels1000_Header) > 1) {
  errors_Fuels1000_Header <- errors_Fuels1000_Header %>%
    filter(Error != "No Error")
} else {
  errors_Fuels1000_Header <- errors_Fuels1000_Header}
```

### Fuel 1000 DecayClass

[Problem:]{.underline} Logs have an entry for decay class that we don’t use.

[Procedure:]{.underline}

-   Check that DecayCl = 3 or 4

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 DecayCl"
query_message <- paste0("Log ", data$LogNum, ". ", "Decay Class")
values_data <- data$DecayCl
values_valid <- c(3,4)
values_check <- values_data %in% values_valid

# Identify errors
errors_Fuels1000_DecayCl <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 Diameter

[Problem:]{.underline}  Values for diameter are missing or unreasonable.

[Procedure:]{.underline}

-   Check that diameter values are ≥ 3.0.

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 Dia"
query_message <- paste0("Log ", data$LogNum, ". ", "Diameter")
values_data <- data$Dia
values_valid <- min(3)
values_check <- values_data >= values_valid

# Identify errors
errors_Fuels1000_Dia_Min <- qaqc(data, query, query_message, values_check)
```

-   Check that diameter values are measured at 0.5 increments.

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 Dia"
query_message <- paste0("Log ", data$LogNum, ". ", "Precision error. Diameter")
values_data <- data$Dia
values_valid <- seq(0, 100, by = 0.5)
values_check <- (values_data %in% values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Fuels1000_Dia_Precision <- qaqc(data, query, query_message, values_check)
```

-   Check that diameter values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Fuels1000_all %>%
  filter(!is.na(Dia))
data_outlier <- rosnerTest(data_temp$Dia)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Dia <- ifelse(length(outliers) == 0, max(data_temp$Dia), min(outliers) - 1)

# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 Dia"
query_message <- paste0("Log ", data$LogNum, ". ", "Possible outlier. Diameter")
values_data <- data$Dia
values_valid <- max_Dia
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Fuels1000_Dia_Max <- qaqc(data, query, query_message, values_check)
```

#### Combine Diameter Errors

```{r}
# Combine
errors_Fuels1000_Dia <- unique(rbind(errors_Fuels1000_Dia_Min, errors_Fuels1000_Dia_Precision, errors_Fuels1000_Dia_Max))

remove(errors_Fuels1000_Dia_Min, errors_Fuels1000_Dia_Precision, errors_Fuels1000_Dia_Max)

if(nrow(errors_Fuels1000_Dia) > 1) {
  errors_Fuels1000_Dia <- errors_Fuels1000_Dia %>%
    filter(Error != "No Error")
} else {
  errors_Fuels1000_Dia <- errors_Fuels1000_Dia}
```

### Fuel 1000 FuelConst

[Problem:]{.underline} Incorrect coarse woody debris fuel constant entered for PIAB or PIED or PIEN or PIPN or PIPO. Fuel constant name should correspond to the MacroPlot Purpose.

[Procedure:]{.underline}

-   Check that CWDFuConSt = MacroPlot.Purpose

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 FuelConst"
query_message <- "Fuel Constant"
values_data <- data$CWDFuConSt
values_valid <- data$MacroPlot.Purpose
values_check <- values_data == values_valid

# Identify errors
errors_Fuels1000_FuelConst <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 LogNo

[Problem:]{.underline} "Duplicate" data exists due to multiple 1000 hr fuels with the same transect / diameter / decay class. Log Numbers are missing (which would differentiate 1000 hr fuels).

[Procedure:]{.underline}

-   Check for duplicate logs across Date, MacroPlot.Name, Transect, LogNum, Dia [and]{.underline} DecayCl.

```{r}
# Check for log duplication and store results in new column
data_temp <- Fuels1000_data %>%
  get_dupes(Date, MacroPlot.Name, Transect, LogNum, Dia, DecayCl)

# Set parameters 
data <- merge(Fuels1000_data, data_temp, all.x = T)
data$dupe_count[is.na(data$dupe_count)] <- 0
query <- "Fuel 1000 LogNo" 
query_message <- paste0("Log ", data$LogNum, ". ", "Transect ", data$Transect, ". ",  "Dia ", data$Dia, ". ",  "DecayCl ", data$DecayCl, ". ", "Duplicates")
values_data <- data$dupe_count
values_valid <- 0
values_check <- values_data == values_valid

# Identify errors
errors_Fuels1000_LogNo <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 Slope

[Problem:]{.underline}  Values for slope are missing or unreasonable.

[Procedure:]{.underline}

-   Check that Slope values are reasonable.

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 Slope"
query_message <- paste0("Transect = ", data$Transect, ". ", "Slope")
values_data <- data$Slope
values_valid <- seq(0, 40, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_Fuels1000_Slope <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 Transect

[Problem:]{.underline} Incorrect values entered for transect.

[Procedure:]{.underline}

-   Check that Transect = 1, 2, 3, or 4

```{r}
# Set parameters
data <- Fuels1000_data
query <- "Fuel 1000 Transect"
query_message <- "Transect Number"
values_data <- data$Transect
values_valid <- c(1, 2, 3, 4)
values_check <- values_data %in% values_valid

# Identify errors
errors_Fuels1000_Transect <- qaqc(data, query, query_message, values_check)
```

### Fuel 1000 Errors

```{r}
# Save to master error list
# errors_Fuels1000 <- unique(rbind(errors_Fuels1000_Complete, errors_Fuels1000_Header, errors_Fuels1000_DecayCl, errors_Fuels1000_Dia, errors_Fuels1000_FuelConst,  errors_Fuels1000_LogNo, errors_Fuels1000_Slope, errors_Fuels1000_Transect))

errors_Fuels1000 <- rbind(errors_Fuels1000_Complete, errors_blank, errors_Fuels1000_Header, errors_blank, errors_Fuels1000_DecayCl, errors_blank, errors_Fuels1000_Dia, errors_blank, errors_Fuels1000_FuelConst, errors_blank, errors_Fuels1000_LogNo, errors_blank, errors_Fuels1000_Slope, errors_blank, errors_Fuels1000_Transect)

remove(errors_Fuels1000_Complete, errors_Fuels1000_Header, errors_Fuels1000_DecayCl, errors_Fuels1000_Dia, errors_Fuels1000_FuelConst,  errors_Fuels1000_LogNo, errors_Fuels1000_Slope, errors_Fuels1000_Transect)
```

```{r}
# Table of results for quick check
#kable(errors_Fuels1000, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_Fuels1000, paste0(path_errors, "errors_GRCA_FMH_Fuels1000.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_Fuels1000, paste0(path_errors, "errors_GRCA_FMH_Fuels1000.xlsx"))
```

## DUFF LITTER (DL)

This code conducts quality control checks on duff litter (DL) surface fuels data within the "Surface Fuels - Duff_Litter" data set.

It checks for errors in: headers, fuel constants, offset values, sample locations, transects, litter values, and duff values.

### Fuel DL Complete

[Problem:]{.underline} Extra or missing data points in FMH plots. There should be 4 transects with 10 sample points per transect. 

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits = 40

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- FuelsDuffLitt_data %>%
  filter(!is.na(LittDep)) %>%
  filter(!is.na(DuffDep)) %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise("sum_hits" = n())

data_temp2 <- FuelsDuffLitt_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(FuelsDuffLitt_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Fuel DL Complete" 
query_message <- "Complete Sample Locations"
values_data <- data$sum_hits
values_valid <- 40
values_check <- values_data == values_valid

# Identify errors
errors_FuelsDuffLitt_Complete <- qaqc(data, query, query_message, values_check)
```

### Fuel DL Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Check that NumTran = 4

```{r}
# Set parameters  
data <- FuelsDuffLitt_header
query <- "Fuel DL Header" 
query_message <- "Number of Transects"  
values_data <- data$NumTran  
values_valid <- 4    
values_check <- values_data == values_valid

# Identify errors
errors_FuelsDuffLitt_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- FuelsDuffLitt_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Fuel DL Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_FuelsDuffLitt_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- FuelsDuffLitt_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Fuel DL Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_FuelsDuffLitt_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
# Combine
errors_FuelsDuffLitt_Header <- unique(rbind(errors_FuelsDuffLitt_NumTran, errors_FuelsDuffLitt_FieldTeam, errors_FuelsDuffLitt_EntryTeam))

remove(errors_FuelsDuffLitt_NumTran, errors_FuelsDuffLitt_FieldTeam, errors_FuelsDuffLitt_EntryTeam)

if(nrow(errors_FuelsDuffLitt_Header) > 1) {
  errors_FuelsDuffLitt_Header <- errors_FuelsDuffLitt_Header %>%
    filter(Error != "No Error")
} else {
  errors_FuelsDuffLitt_Header <- errors_FuelsDuffLitt_Header}
```

### Fuel DL FuelConst

[Problem:]{.underline} Incorrect duff & litter fuel constant entered for PIAB or PIED or PIEN or PIPN or PIPO. Fuel constant name should correspond to the MacroPlot Purpose.

[Procedure:]{.underline}

-   Check that DLFuConSt = MacroPlot.Purpose

```{r}
# Set parameters 
data <- FuelsDuffLitt_data
query <- "Fuel DL FuelConst" 
query_message <- "Fuel Constant" 
values_data <- data$DLFuConSt 
values_valid <- data$MacroPlot.Purpose 
values_check <- values_data == values_valid

# Identify errors
errors_FuelsDuffLitt_FuelConst <- qaqc(data, query, query_message, values_check)
```

### Fuel DL OffSet

[Problem:]{.underline} Incorrect values entered for OffSet column.

[Procedure:]{.underline}

-   Check that OffSet = False

```{r}
# Set parameters 
data <- FuelsDuffLitt_data
query <- "Fuel DL OffSet" 
query_message <- "OffSet" 
values_data <- data$OffSet
values_valid <- "False"
values_check <- values_data == values_valid

# Identify errors
errors_FuelsDuffLitt_OffSet <- qaqc(data, query, query_message, values_check)
```

### Fuel DL SampLoc

[Problem:]{.underline} Incorrect values entered for sample location.

[Procedure:]{.underline}

-   Check that SampLoc = 1, 5, 10, 15, 20, 25, 30, 35, 40, or 45

```{r}
# Set parameters
data <- FuelsDuffLitt_data
query <- "Fuel DL SampLoc"
query_message <- "Sample Location"
values_data <- data$SampLoc
values_valid <- c(1, 5, 10, 15, 20, 25, 30, 35, 40, 45)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsDuffLitt_SampLoc <- qaqc(data, query, query_message, values_check)
```

### Fuel DL Transect

[Problem:]{.underline} Incorrect values entered for transect.

[Procedure:]{.underline}

-   Check that Transect = 1, 2, 3, or 4

```{r}
# Set parameters
data <- FuelsDuffLitt_data
query <- "Fuel DL Transect"
query_message <- "Transect Number"
values_data <- data$Transect
values_valid <- c(1, 2, 3, 4)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsDuffLitt_Transect <- qaqc(data, query, query_message, values_check)
```

### Fuel DL Values

[Problem:]{.underline}  Values for litter and duff depth are missing or unreasonable.

[Procedure:]{.underline}

-   Sort by LittDep. Check that litter depth values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- FuelsDuffLitt_all %>%
  filter(!is.na(LittDep))
data_outlier <- rosnerTest(data_temp$LittDep)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Litt <- ifelse(length(outliers) == 0, max(data_temp$LittDep), min(outliers) - 0.1)

# Set parameters 
data <- FuelsDuffLitt_data
query <- "Fuel DL Values LittDep" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Sample Location = ", data$SampLoc, ". ", "Possible outlier. Litter Depth")
values_data <- data$LittDep
values_valid <- max_Litt
values_check <- values_data <= values_valid

# Identify errors
errors_FuelsDuffLitt_LittDep <- qaqc(data, query, query_message, values_check)
```

-   Sort by DuffDep. Check that duff depth values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- FuelsDuffLitt_all %>%
  filter(!is.na(DuffDep))
data_outlier <- rosnerTest(data_temp$DuffDep)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Duff <- ifelse(length(outliers) == 0, max(data_temp$DuffDep), min(outliers) - 0.1)

# Set parameters 
data <- FuelsDuffLitt_data
query <- "Fuel DL Values DuffDep" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Sample Location = ", data$SampLoc, ". ", "Possible outlier. Duff Depth")
values_data <- data$DuffDep
values_valid <- max_Duff
values_check <- values_data <= values_valid

# Identify errors
errors_FuelsDuffLitt_DuffDep <- qaqc(data, query, query_message, values_check)
```

#### Combine Values Errors

```{r}
# Combine
errors_FuelsDuffLitt_Values <- unique(rbind(errors_FuelsDuffLitt_LittDep, errors_FuelsDuffLitt_DuffDep))

remove(errors_FuelsDuffLitt_LittDep, errors_FuelsDuffLitt_DuffDep)
```

### Fuel DL Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that FuelbedDepth = blank

```{r}
# Set parameters
data <- FuelsDuffLitt_data
data$FuelbedDep[is.na(data$FuelbedDep)] <- ""
query <- "Fuel DL Zero/NA"
query_message <- "FuelbedDepth"
values_data <- data$FuelbedDep
values_valid <- c("", 0)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsDuffLitt_Zero <- qaqc(data, query, query_message, values_check)
```

### Fuel DL Errors

```{r}
# Save to master error list 
# errors_FuelsDuffLitt <- unique(rbind(errors_FuelsDuffLitt_Complete, errors_FuelsDuffLitt_Header, errors_FuelsDuffLitt_FuelConst, errors_FuelsDuffLitt_OffSet, errors_FuelsDuffLitt_SampLoc, errors_FuelsDuffLitt_Transect, errors_FuelsDuffLitt_Values, errors_FuelsDuffLitt_Zero))

errors_FuelsDuffLitt <- rbind(errors_FuelsDuffLitt_Complete, errors_blank, errors_FuelsDuffLitt_Header, errors_blank, errors_FuelsDuffLitt_FuelConst, errors_blank, errors_FuelsDuffLitt_OffSet, errors_blank, errors_FuelsDuffLitt_SampLoc, errors_blank, errors_FuelsDuffLitt_Transect, errors_blank, errors_FuelsDuffLitt_Values, errors_blank, errors_FuelsDuffLitt_Zero)

remove(errors_FuelsDuffLitt_Complete, errors_FuelsDuffLitt_Header, errors_FuelsDuffLitt_FuelConst, errors_FuelsDuffLitt_OffSet, errors_FuelsDuffLitt_SampLoc, errors_FuelsDuffLitt_Transect, errors_FuelsDuffLitt_Values, errors_FuelsDuffLitt_Zero)
```

```{r}
# Table of results for quick check
#kable(errors_FuelsDuffLitt, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_FuelsDuffLitt, paste0(path_errors, "errors_GRCA_FMH_FuelsDuffLitt.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_FuelsDuffLitt, paste0(path_errors, "errors_GRCA_FMH_FuelsDuffLitt.xlsx"))
```

## FINE FUELS (FWD)

This code conducts quality control checks on fine woody debris (FWD) surface fuels data within the "Surface Fuels - Fine" data set.

It checks for errors in: headers, azimuth, fuel constants, slope, transects, and One/Ten/Hundred Hour count values.

### Fuel Fine Complete

[Problem:]{.underline} Extra or missing data points in FMH plots. There should be 4 transects with 1 sample point per transect. 

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits = 4

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- FuelsFine_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- FuelsFine_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(FuelsFine_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Fuel Fine Complete" 
query_message <- "Complete Transects" 
values_data <- data$sum_hits
values_valid <- 4
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_Complete <- qaqc(data, query, query_message, values_check)
```

### Fuel Fine Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Check that NumTran = 4

```{r}
# Set parameters  
data <- FuelsFine_header
query <- "Fuel Fine Header" 
query_message <- "Number of Transects"  
values_data <- data$NumTran  
values_valid <- 4    
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that OneHrTranLen = 6

```{r}
# Set parameters  
data <- FuelsFine_header
query <- "Fuel Fine Header" 
query_message <- "One Hour Transect Length"  
values_data <- data$OneHrTranLen
values_valid <- 6
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_OneHrTranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that TenHrTranLen = 6

```{r}
# Set parameters  
data <- FuelsFine_header
query <- "Fuel Fine Header" 
query_message <- "Ten Hour Transect Length"  
values_data <- data$TenHrTranLen 
values_valid <- 6
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_TenHrTranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that HunHrTranLen = 12

```{r}
# Set parameters  
data <- FuelsFine_header
query <- "Fuel Fine Header" 
query_message <- "Hundrend Hour Transect Length"  
values_data <- data$HunHrTranLen 
values_valid <- 12
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_HunHrTranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- FuelsFine_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Fuel Fine Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_FuelsFine_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- FuelsFine_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Fuel Fine Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_FuelsFine_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
# Combine
errors_FuelsFine_Header <- unique(rbind(errors_FuelsFine_NumTran, errors_FuelsFine_OneHrTranLen, errors_FuelsFine_TenHrTranLen, errors_FuelsFine_HunHrTranLen, errors_FuelsFine_FieldTeam, errors_FuelsFine_EntryTeam))

remove(errors_FuelsFine_NumTran, errors_FuelsFine_OneHrTranLen, errors_FuelsFine_TenHrTranLen, errors_FuelsFine_HunHrTranLen, errors_FuelsFine_FieldTeam, errors_FuelsFine_EntryTeam)

if(nrow(errors_FuelsFine_Header) > 1) {
  errors_FuelsFine_Header <- errors_FuelsFine_Header %>%
    filter(Error != "No Error")
} else {
  errors_FuelsFine_Header <- errors_FuelsFine_Header}
```

### Fuel Fine Azimuth

[Problem:]{.underline}  Values for azimuth are missing or unreasonable.

[Procedure:]{.underline}

-   Check that Azimuth values are reasonable.

```{r}
# Set parameters
data <- FuelsFine_data
query <- "Fuel Fine Azimuth"
query_message <- paste0("Transect = ", data$Transect, ". ", "Azimuth")
values_data <- data$Azimuth
values_valid <- seq(0, 359, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_Azimuth <- qaqc(data, query, query_message, values_check)
```

### Fuel Fine FuelConst

[Problem:]{.underline} Incorrect fine woody debris fuel constant entered for PIAB or PIED or PIEN or PIPN or PIPO. Fuel constant name should correspond to the MacroPlot Purpose.

[Procedure:]{.underline}

-   Check that FWDFuConSt = MacroPlot.Purpose

```{r}
# Set parameters 
data <- FuelsFine_data
query <- "Fuel Fine FuelConst" 
query_message <- "Fuel Constant" 
values_data <- data$FWDFuConSt 
values_valid <- data$MacroPlot.Purpose  
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_FuelConst <- qaqc(data, query, query_message, values_check)
```

### Fuel Fine Slope

[Problem:]{.underline}  Values for slope are missing or unreasonable.

[Procedure:]{.underline}

-   Check that Slope values are reasonable.

```{r}
# Set parameters
data <- FuelsFine_data
query <- "Fuel Fine Slope"
query_message <- paste0("Transect = ", data$Transect, ". ", "Slope")
values_data <- data$Slope
values_valid <- seq(0, 40, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_Slope_Value <- qaqc(data, query, query_message, values_check)
```

-   Check for consistency in slope values across Fuels 1000 and Fuels Fine protocols.

```{r}
data_temp1 <- Fuels1000_data %>%
  group_by(MacroPlot.Name, Date, Transect, Slope) %>%
  dplyr::summarise("MacroPlot.Name" = unique(MacroPlot.Name),
            "Transect" = unique(Transect)) %>%
  mutate(Slope_1000 = Slope) %>%
  arrange(MacroPlot.Name, Transect) %>%
  select(!Slope)

data_temp2 <- FuelsFine_data %>%
  group_by(MacroPlot.Name, Date, Transect, Slope) %>%
  dplyr::summarise("MacroPlot.Name" = unique(MacroPlot.Name),
            "Transect" = unique(Transect)) %>%
  mutate(Slope_fine = Slope) %>%
  arrange(MacroPlot.Name, Transect) %>%
  select(!Slope)

data_temp <- merge(data_temp1, data_temp2, all.y = T)
data_temp <- data_temp %>% 
  mutate(Slope_1000 = ifelse(is.na(Slope_1000), Slope_fine, Slope_1000))
remove(data_temp1, data_temp2)

# Set parameters
data <- merge(FuelsFine_data, data_temp, by = c("MacroPlot.Name", "Date", "Transect"), all = T)
query <- "Fuel Fine Slope"
query_message <- paste0("Transect = ", data$Transect, ". ", "CWD slope = ", data$Slope_1000, ". ", "FWD slope")
values_data <- data$Slope_fine
values_valid <- data$Slope_1000
values_check <- values_data == values_valid

# Identify errors
errors_FuelsFine_Slope_FineCWD <- qaqc(data, query, query_message, values_check)
```

#### Combine Slope Errors

```{r}
# Combine
errors_FuelsFine_Slope <- unique(rbind(errors_FuelsFine_Slope_Value, errors_FuelsFine_Slope_FineCWD))

remove(errors_FuelsFine_Slope_Value, errors_FuelsFine_Slope_FineCWD)

if(nrow(errors_FuelsFine_Slope) > 1) {
  errors_FuelsFine_Slope <- errors_FuelsFine_Slope %>%
    filter(Error != "No Error")
} else {
  errors_FuelsFine_Slope <- errors_FuelsFine_Slope}
```

### Fuel Fine Transect

[Problem:]{.underline} Incorrect values entered for transect.

[Procedure:]{.underline}

-   Check that Transect = 1, 2, 3, or 4

```{r}
# Set parameters
data <- FuelsFine_data
query <- "Fuel Fine Transect"
query_message <- "Transect Number"
values_data <- data$Transect
values_valid <- c(1, 2, 3, 4)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_Transect <- qaqc(data, query, query_message, values_check)
```

### Fuel Fine Values

[Problem:]{.underline} Values for One, Ten, and Hundred Hour fuel counts are missing or unreasonable.

[Procedure:]{.underline}

-   Check that One Hour values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- FuelsFine_all %>%
  filter(!is.na(OneHr))
data_outlier <- rosnerTest(data_temp$OneHr)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_One <- ifelse(length(outliers) == 0, max(data_temp$OneHr), min(outliers) - 1)

# Set parameters 
data <- FuelsFine_data
query <- "Fuel Fine Values OneHr" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Possible outlier. One Hour Count")
values_data <- data$OneHr
values_valid <- seq(0, max_One, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_OneHr <- qaqc(data, query, query_message, values_check)
```

-   Check that Ten Hour values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- FuelsFine_all %>%
  filter(!is.na(TenHr))
data_outlier <- rosnerTest(data_temp$TenHr)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Ten <- ifelse(length(outliers) == 0, max(data_temp$TenHr), min(outliers) - 1)

# Set parameters 
data <- FuelsFine_data
query <- "Fuel Fine Values TenHr" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Possible outlier. Ten Hour Count")
values_data <- data$TenHr
values_valid <- seq(0, max_Ten, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_TenHr <- qaqc(data, query, query_message, values_check)
```

-   Check that Hundred Hour values are reasonable.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- FuelsFine_all %>%
  filter(!is.na(HunHr))
data_outlier <- rosnerTest(data_temp$HunHr)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Hun <- ifelse(length(outliers) == 0, max(data_temp$HunHr), min(outliers) - 1)

# Set parameters 
data <- FuelsFine_data
query <- "Fuel Fine Values HunHr" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Possible outlier. Hundred Hour Count") 
values_data <- data$HunHr
values_valid <- seq(0, max_Hun, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_FuelsFine_HunHr <- qaqc(data, query, query_message, values_check)
```

#### Combine Values Errors

```{r}
# Combine
errors_FuelsFine_Values <- unique(rbind(errors_FuelsFine_OneHr, errors_FuelsFine_TenHr, errors_FuelsFine_HunHr))

remove(errors_FuelsFine_OneHr, errors_FuelsFine_TenHr, errors_FuelsFine_HunHr)
```

### Fuel Fine Errors

```{r}
# Save to master error list 
# errors_FuelsFine <- unique(rbind(errors_FuelsFine_Complete, errors_FuelsFine_Header, errors_FuelsFine_Azimuth, errors_FuelsFine_FuelConst, errors_FuelsFine_Slope, errors_FuelsFine_Transect, errors_FuelsFine_Values))

errors_FuelsFine <- rbind(errors_FuelsFine_Complete, errors_blank, errors_FuelsFine_Header, errors_blank, errors_FuelsFine_Azimuth, errors_blank, errors_FuelsFine_FuelConst, errors_blank, errors_FuelsFine_Slope, errors_blank, errors_FuelsFine_Transect, errors_blank, errors_FuelsFine_Values)

remove(errors_FuelsFine_Complete, errors_FuelsFine_Header, errors_FuelsFine_Azimuth, errors_FuelsFine_FuelConst, errors_FuelsFine_Slope, errors_FuelsFine_Transect, errors_FuelsFine_Values)
```

```{r}
# Table of results for quick check
#kable(errors_FuelsFine, "pipe")

# Save as CSV or XLSX 
path_errors
#write.csv(errors_FuelsFine, paste0(path_errors, "errors_GRCA_FMH_FuelsFine.csv"), quote=FALSE, row.names = FALSE, na = "") 
#write_xlsx(errors_FuelsFine, paste0(path_errors, "errors_GRCA_FMH_FuelsFine.xlsx"))
```

# PROTOCOL - POST BURN

This code conducts quality control checks on post burn data within the "Post Burn Severity" data set.

It checks for errors in: headers, points, tape distance, transect, substrate, and vegetation values.

### PBSev Complete

[Problem:]{.underline} Extra or missing data points in FMH plots. There should be 4 transects with 10 sample points per transect.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits = 40

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- PostBurn_data %>%
  filter(!is.na(Veg)) %>%
  filter(!is.na(Sub)) %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise("sum_hits" = n())

data_temp2 <- PostBurn_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(PostBurn_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "PBSev Complete" 
query_message <- "Complete Sample Locations"
values_data <- data$sum_hits
values_valid <- 40
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_Complete <- qaqc(data, query, query_message, values_check)
```

### PBSev Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Check that NumTran = 4

```{r}
# Set parameters
data <- PostBurn_header
query <- "PBSev Header"
query_message <- "Number of Transects"
values_data <- data$NumTran
values_valid <- 4
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that TranLen = 50

```{r}
# Set parameters
data <- PostBurn_header
query <- "PBSev Header"
query_message <- "Transect Length"
values_data <- data$TranLen
values_valid <- 50
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_TranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that NumPtsTran = 10

```{r}
# Set parameters
data <- PostBurn_header
query <- "PBSev Header"
query_message <- "Number of Points"
values_data <- data$NumPtsTran
values_valid <- 10
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_NumPtsTran <- qaqc(data, query, query_message, values_check)
```

-   Check that PlotType = Forest

```{r}
# Set parameters
data <- PostBurn_header
query <- "PBSev Header"
query_message <- "Plot Type"
values_data <- data$PlotType
values_valid <- "Forest"
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_PlotType <- qaqc(data, query, query_message, values_check)
```

-   Check that PtArea is blank

```{r}
# Set parameters
data <- PostBurn_header
data$PtArea[is.na(data$PtArea)] <- ""
query <- "PBSev Header"
query_message <- "Point Area"
values_data <- data$PtArea
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_PostBurn_PtArea <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- PostBurn_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "PBSev Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_PostBurn_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- PostBurn_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "PBSev Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_PostBurn_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
# Combine
errors_PostBurn_Header <- unique(rbind(errors_PostBurn_NumTran, errors_PostBurn_TranLen, errors_PostBurn_NumPtsTran, errors_PostBurn_PlotType, errors_PostBurn_PtArea, errors_PostBurn_FieldTeam, errors_PostBurn_EntryTeam))

remove(errors_PostBurn_NumTran, errors_PostBurn_TranLen, errors_PostBurn_NumPtsTran, errors_PostBurn_PlotType, errors_PostBurn_PtArea, errors_PostBurn_FieldTeam, errors_PostBurn_EntryTeam)

if(nrow(errors_PostBurn_Header) > 1) {
  errors_PostBurn_Header <- errors_PostBurn_Header %>%
    filter(Error != "No Error")
} else {
  errors_PostBurn_Header <- errors_PostBurn_Header}
```

### PBSev Point

[Problem:]{.underline} Incorrect values entered for point.

[Procedure:]{.underline}

-   Check that Point = 1, 2, 3, 4, 5, 6, 7, 8, 9, or 10

```{r}
# Set parameters
data <- PostBurn_data
query <- "PBSev Point"
query_message <- "Point"
values_data <- data$Point
values_valid <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
values_check <- values_data %in% values_valid

# Identify errors
errors_PostBurn_Point <- qaqc(data, query, query_message, values_check)
```

### PBSev TapeDist

[Problem:]{.underline} Incorrect values entered for tape distance.

[Procedure:]{.underline}

-   Check that TapeDist = 1, 5, 10, 15, 20, 25, 30, 35, 40, or 45

```{r}
# Set parameters
data <- PostBurn_data
query <- "PBSev TapeDist"
query_message <- "Tape Distance"
values_data <- data$TapeDist
values_valid <- c(1, 5, 10, 15, 20, 25, 30, 35, 40, 45)
values_check <- values_data %in% values_valid

# Identify errors
errors_PostBurn_TapeDist <- qaqc(data, query, query_message, values_check)
```

### PBSev Transect

[Problem:]{.underline} Incorrect values entered for transect.

[Procedure:]{.underline}

-   Check that Transect = 1, 2, 3, or 4

```{r}
# Set parameters
data <- PostBurn_data
query <- "PBSev Transect"
query_message <- "Transect Number"
values_data <- data$Transect
values_valid <- c(1, 2, 3, 4)
values_check <- values_data %in% values_valid

# Identify errors
errors_PostBurn_Transect <- qaqc(data, query, query_message, values_check)
```

### PBSev Values

[Problem:]{.underline} Incorrect values entered for substrate and vegetation.

[Procedure:]{.underline}

-   Check that Sub = 0, 1, 2, 3, 4, or 5

```{r}
# Set parameters
data <- PostBurn_data
query <- "PBSev Values Sub"
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Substrate Severity")
values_data <- data$Sub
values_valid <- c(0, 1, 2, 3, 4, 5)
values_check <- values_data %in% values_valid

# Identify errors
errors_PostBurn_Sub <- qaqc(data, query, query_message, values_check)
```

-   Check that Veg = 0, 1, 2, 3, 4, or 5

```{r}
# Set parameters
data <- PostBurn_data
query <- "PBSev Values Veg"
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Vegetation Severity")
values_data <- data$Veg
values_valid <- c(0, 1, 2, 3, 4, 5)
values_check <- values_data %in% values_valid

# Identify errors
errors_PostBurn_Veg <- qaqc(data, query, query_message, values_check)
```

#### Combine Values Errors

```{r}
# Combine
errors_PostBurn_Values <- unique(rbind(errors_PostBurn_Sub, errors_PostBurn_Veg))

remove(errors_PostBurn_Sub, errors_PostBurn_Veg)
```

### PBSev Errors

```{r}
# Save to master error list
# errors_PostBurn <- unique(rbind(errors_PostBurn_Complete, errors_PostBurn_Header, errors_PostBurn_Point, errors_PostBurn_TapeDist, errors_PostBurn_Transect, errors_PostBurn_Values))

errors_PostBurn <- rbind(errors_PostBurn_Complete, errors_blank, errors_PostBurn_Header, errors_blank, errors_PostBurn_Point, errors_blank, errors_PostBurn_TapeDist, errors_blank, errors_PostBurn_Transect, errors_blank, errors_PostBurn_Values)

remove(errors_PostBurn_Complete, errors_PostBurn_Header, errors_PostBurn_Point, errors_PostBurn_TapeDist, errors_PostBurn_Transect, errors_PostBurn_Values)
```

```{r}
# Table of results for quick check
#kable(errors_PostBurn, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_PostBurn, paste0(path_errors, "errors_GRCA_FMH_PostBurn.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_PostBurn, paste0(path_errors, "errors_GRCA_FMH_PostBurn.xlsx"))
```

# PROTOCOL - TREES

This code conducts quality control checks on tree data within the "Trees - Individuals (metric)" data set.

It checks for errors in: headers, crown base height, crown class, damage codes, DBH, dead and down, duplicates, subplot fractions, height, life form, non-post severity, post severity, status, and user variables.

### Trees Complete

[Problem:]{.underline} Missing data points in FMH plots. Plots with no trees should be verified.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits \> 0

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- Trees_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- Trees_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(Trees_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Trees Complete" 
query_message <- "Trees" 
values_data <- data$sum_hits
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_Trees_Complete <- qaqc(data, query, query_message, values_check)
```

### Trees Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Check that MacroPlotSize = 0.1

```{r}
# Set parameters  
data <- Trees_header
query <- "Trees Header" 
query_message <- "Macro Plot Size"  
values_data <- data$MacroPlotSize  
values_valid <- 0.1
values_check <- values_data == values_valid

# Identify errors
errors_Trees_MacroPlotSize <- qaqc(data, query, query_message, values_check)
```

-   Check that SnagPlotSize = 0.1

```{r}
# Set parameters  
data <- Trees_header
query <- "Trees Header" 
query_message <- "Snag Plot Size"  
values_data <- data$SnagPlotSize
values_valid <- 0.1    
values_check <- values_data == values_valid

# Identify errors
errors_Trees_SnagPlotSize <- qaqc(data, query, query_message, values_check)
```

-   Check that BrkPntDia = 15

```{r}
# Set parameters  
data <- Trees_header
query <- "Trees Header" 
query_message <- "Break Point Diameter"  
values_data <- data$BrkPntDia
values_valid <- 15
values_check <- values_data == values_valid

# Identify errors
errors_Trees_BrkPntDia <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Trees_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Trees Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Trees_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Trees_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Trees Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Trees_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
# Save to master error list 
errors_Trees_Header <- unique(rbind(errors_Trees_MacroPlotSize, errors_Trees_SnagPlotSize, errors_Trees_BrkPntDia, errors_Trees_FieldTeam, errors_Trees_EntryTeam))

remove(errors_Trees_MacroPlotSize, errors_Trees_SnagPlotSize, errors_Trees_BrkPntDia, errors_Trees_FieldTeam, errors_Trees_EntryTeam)

if(nrow(errors_Trees_Header) > 1) {
  errors_Trees_Header <- errors_Trees_Header %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Header <- errors_Trees_Header}
```

### Trees CBH

[Problem]{.underline}: Live Crown Base Height is entered incorrectly.

[Procedure:]{.underline}

-   Filter by Status = L and DBH = Overstory. Check that LiCrBHt is [not]{.underline} blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L", DBH > 15.0)
data$LiCrBHt[is.na(data$LiCrBHt)] <- ""
query <- "Trees CBH" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. DBH = overstory. Live Crown Base Height")
values_data <- data$LiCrBHt
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Trees_CBH_Live <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = D. Check that LiCrBHt is blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
data$LiCrBHt[is.na(data$LiCrBHt)] <- ""
query <- "Trees CBH" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Live Crown Base Height")
values_data <- data$LiCrBHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CBH_Dead <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = L. Check that LiCrBHt \< Ht

```{r}
# Set parameters
data <- Trees_data %>% 
  filter(!is.na(LiCrBHt), Status == "L")
query <- "Trees CBH" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Height shorter than CBH. CBH")
values_data <- data$LiCrBHt
values_valid <- data$Ht
values_check <- values_data < values_valid

# Identify errors
errors_Trees_CBH_Ht <- qaqc(data, query, query_message, values_check)
```

#### Combine CBH Errors

```{r}
# Combine
errors_Trees_CBH <- unique(rbind(errors_Trees_CBH_Live, errors_Trees_CBH_Dead, errors_Trees_CBH_Ht))

remove(errors_Trees_CBH_Live, errors_Trees_CBH_Dead, errors_Trees_CBH_Ht)

if(nrow(errors_Trees_CBH) > 1) {
  errors_Trees_CBH <- errors_Trees_CBH %>%
    filter(Error != "No Error")
} else {
  errors_Trees_CBH <- errors_Trees_CBH}
```

### Trees Crown Class

[Problem]{.underline}: Incompatible values entered for tree crown class.

[Procedure:]{.underline}

-   Filter by Status = D and DBH = blank. Check that CrwnCl = BBD, CUS, or DD

```{r}
# Set parameters  
data <- Trees_data %>% 
  filter(is.na(DBH), Status == "D")
query <- "Trees Crown Class" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. DBH = blank. Crown Class")  
values_data <- data$CrwnCl
values_valid <- c("DD", "BBD", "CUS")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_CrwnCl_D <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = L and DBH = blank. Check that CrwnCl = blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(is.na(DBH), Status == "L")
query <- "Trees Crown Class" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. DBH = blank. Crown Class")  
values_data <- data$CrwnCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CrwnCl_L <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = D and DBH = Overstory. Check that CrwnCl = BAD, CS, LBS, or RS or blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DBH > 15.0, Status == "D")
query <- "Trees Crown Class" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. DBH = overstory. Crown Class")
values_data <- data$CrwnCl
values_valid <- c("BAD", "CS", "LBS", "RS")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_CrwnCl_D_Overstory <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = L and DBH = Overstory. Check that CrwnCl = C, D, I, O, or SC or blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DBH > 15.0, Status == "L")
query <- "Trees Crown Class" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. DBH = overstory. Crown Class") 
values_data <- data$CrwnCl
values_valid <- c("C", "D", "I", "O", "SC")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_CrwnCl_L_Overstory <- qaqc(data, query, query_message, values_check)
```

-   Filter by DBH = Pole. Check that CrwnCl = X or blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DBH <= 15.0)
query <- "Trees Crown Class" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = pole. Crown Class") 
values_data <- data$CrwnCl
values_valid <- c("X", "")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_CrwnCl_Pole <- qaqc(data, query, query_message, values_check)
```

#### Combine Crown Class Errors

```{r}
# Save to master error list 
errors_Trees_CrwnCl <- unique(rbind(errors_Trees_CrwnCl_D, errors_Trees_CrwnCl_L, errors_Trees_CrwnCl_D_Overstory, errors_Trees_CrwnCl_L_Overstory, errors_Trees_CrwnCl_Pole))

remove(errors_Trees_CrwnCl_D, errors_Trees_CrwnCl_L, errors_Trees_CrwnCl_D_Overstory, errors_Trees_CrwnCl_L_Overstory, errors_Trees_CrwnCl_Pole)

if(nrow(errors_Trees_CrwnCl) > 1) {
  errors_Trees_CrwnCl <- errors_Trees_CrwnCl %>%
    filter(Error != "No Error")
} else {
  errors_Trees_CrwnCl <- errors_Trees_CrwnCl}
```

### Trees Damage

[Problem]{.underline}: Tree damage codes are entered incorrectly.

[Procedure:]{.underline}

-   Filter by Status = L. Check that DamCd1, DamCd2, DamCd3, DamCd4, [and]{.underline} DamCd5 correspond to one of the choices on the FMH-1 overstory data sheets.

```{r}
# Make sure damage codes are blank vs NA
Trees_data$DamCd1[is.na(Trees_data$DamCd1)] <- ""
Trees_data$DamCd2[is.na(Trees_data$DamCd2)] <- ""
Trees_data$DamCd3[is.na(Trees_data$DamCd3)] <- ""
Trees_data$DamCd4[is.na(Trees_data$DamCd4)] <- ""
Trees_data$DamCd5[is.na(Trees_data$DamCd5)] <- ""
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Damage Code 1")  
values_data <- data$DamCd1
values_valid <- c("", "ABGR", "BIRD", "BLIG", "BROK", "BROM", "BURL", "CONK", "CROK", "DTOP", "EPIC", "EPIP", "FIRE", "FORK", "FRST", "GALL", "HOLW", "INSE", "LEAN", "LICH", "LIGT", "MAMM", "MISL", "MOSS", "OZON", "ROOT", "ROTT", "SPAR", "SPRT", "TWIN", "UMAN", "WOND")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_L_1 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Damage Code 2")  
values_data <- data$DamCd2
values_valid <- c("", "ABGR", "BIRD", "BLIG", "BROK", "BROM", "BURL", "CONK", "CROK", "DTOP", "EPIC", "EPIP", "FIRE", "FORK", "FRST", "GALL", "HOLW", "INSE", "LEAN", "LICH", "LIGT", "MAMM", "MISL", "MOSS", "OZON", "ROOT", "ROTT", "SPAR", "SPRT", "TWIN", "UMAN", "WOND")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_L_2 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Damage Code 3") 
values_data <- data$DamCd3
values_valid <- c("", "ABGR", "BIRD", "BLIG", "BROK", "BROM", "BURL", "CONK", "CROK", "DTOP", "EPIC", "EPIP", "FIRE", "FORK", "FRST", "GALL", "HOLW", "INSE", "LEAN", "LICH", "LIGT", "MAMM", "MISL", "MOSS", "OZON", "ROOT", "ROTT", "SPAR", "SPRT", "TWIN", "UMAN", "WOND")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_L_3 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Damage Code 4")  
values_data <- data$DamCd4
values_valid <- c("", "ABGR", "BIRD", "BLIG", "BROK", "BROM", "BURL", "CONK", "CROK", "DTOP", "EPIC", "EPIP", "FIRE", "FORK", "FRST", "GALL", "HOLW", "INSE", "LEAN", "LICH", "LIGT", "MAMM", "MISL", "MOSS", "OZON", "ROOT", "ROTT", "SPAR", "SPRT", "TWIN", "UMAN", "WOND")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_L_4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "L")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Damage Code 5")  
values_data <- data$DamCd5
values_valid <- c("", "ABGR", "BIRD", "BLIG", "BROK", "BROM", "BURL", "CONK", "CROK", "DTOP", "EPIC", "EPIP", "FIRE", "FORK", "FRST", "GALL", "HOLW", "INSE", "LEAN", "LICH", "LIGT", "MAMM", "MISL", "MOSS", "OZON", "ROOT", "ROTT", "SPAR", "SPRT", "TWIN", "UMAN", "WOND")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_L_5 <- qaqc(data, query, query_message, values_check)
```

-   Filter by Status = D. Check that DamCd1, DamCd2, DamCd3, DamCd4, [and]{.underline} DamCd5 are blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Damage Code 1")
values_data <- data$DamCd1
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_D_1 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Damage Code 2")  
values_data <- data$DamCd2
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_D_2 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Damage Code 3")
values_data <- data$DamCd3
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_D_3 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Damage Code 4")
values_data <- data$DamCd4
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_D_4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Status == "D")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Damage Code 5")
values_data <- data$DamCd5
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_D_5 <- qaqc(data, query, query_message, values_check)
```

-   Filter by DamCd1 = blank. Check that DamCd2, DamCd3, DamCd4, [and]{.underline} DamCd5 are blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd1 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 1 = Blank, Damage Code 2")
values_data <- data$DamCd2
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_1_Blank_2 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd1 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 1 = Blank, Damage Code 3")
values_data <- data$DamCd3
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_1_Blank_3 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd1 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 1 = Blank, Damage Code 4")
values_data <- data$DamCd4
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_1_Blank_4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data  %>% 
  filter(DamCd1 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 1 = Blank, Damage Code 5")
values_data <- data$DamCd5
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_1_Blank_5 <- qaqc(data, query, query_message, values_check)
```

-   Filter by DamCd2 = blank. Check that DamCd3, DamCd4, [and]{.underline} DamCd5 are blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd2 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 2 = Blank, Damage Code 3")
values_data <- data$DamCd3
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_2_Blank_3 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd2 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 2 = Blank, Damage Code 4")
values_data <- data$DamCd4
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_2_Blank_4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd2 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 2 = Blank, Damage Code 5")
values_data <- data$DamCd5
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_2_Blank_5 <- qaqc(data, query, query_message, values_check)
```

-   Filter by DamCd3 = blank. Check that DamCd4 [and]{.underline} DamCd5 are blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd3 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 3 = Blank, Damage Code 4")
values_data <- data$DamCd4
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_3_Blank_4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd3 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 3 = Blank, Damage Code 5")
values_data <- data$DamCd5
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_3_Blank_5 <- qaqc(data, query, query_message, values_check)
```

-   Filter by DamCd4 = blank. Check that DamCd5 is blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DamCd4 == "")
query <- "Trees Damage" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Damage Code 4 = Blank, Damage Code 5")
values_data <- data$DamCd5
values_valid <- ""
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_DamCd_4_Blank_5 <- qaqc(data, query, query_message, values_check)
```

#### Combine Damage Errors

```{r}
# Damage Errors Live Trees
errors_Trees_DamCd_L <- unique(rbind(errors_Trees_DamCd_L_1, errors_Trees_DamCd_L_2, errors_Trees_DamCd_L_3, errors_Trees_DamCd_L_4, errors_Trees_DamCd_L_5))

remove(errors_Trees_DamCd_L_1, errors_Trees_DamCd_L_2, errors_Trees_DamCd_L_3, errors_Trees_DamCd_L_4, errors_Trees_DamCd_L_5)

# Damage Errors Dead Trees
errors_Trees_DamCd_D <- unique(rbind(errors_Trees_DamCd_D_1, errors_Trees_DamCd_D_2, errors_Trees_DamCd_D_3, errors_Trees_DamCd_D_4, errors_Trees_DamCd_D_5))

remove(errors_Trees_DamCd_D_1, errors_Trees_DamCd_D_2, errors_Trees_DamCd_D_3, errors_Trees_DamCd_D_4, errors_Trees_DamCd_D_5)

# Damage Errors Blank Entries
errors_Trees_DamCd_Blank <- unique(rbind(errors_Trees_DamCd_1_Blank_2, errors_Trees_DamCd_1_Blank_3, errors_Trees_DamCd_1_Blank_4, errors_Trees_DamCd_1_Blank_5, errors_Trees_DamCd_2_Blank_3, errors_Trees_DamCd_2_Blank_4, errors_Trees_DamCd_2_Blank_5, errors_Trees_DamCd_3_Blank_4, errors_Trees_DamCd_3_Blank_5, errors_Trees_DamCd_4_Blank_5))

remove(errors_Trees_DamCd_1_Blank_2, errors_Trees_DamCd_1_Blank_3, errors_Trees_DamCd_1_Blank_4, errors_Trees_DamCd_1_Blank_5, errors_Trees_DamCd_2_Blank_3, errors_Trees_DamCd_2_Blank_4, errors_Trees_DamCd_2_Blank_5, errors_Trees_DamCd_3_Blank_4, errors_Trees_DamCd_3_Blank_5, errors_Trees_DamCd_4_Blank_5)

# Damage Errors Combined
errors_Trees_DamCd <- unique(rbind(errors_Trees_DamCd_L, errors_Trees_DamCd_D, errors_Trees_DamCd_Blank))

remove(errors_Trees_DamCd_L, errors_Trees_DamCd_D, errors_Trees_DamCd_Blank)

if(nrow(errors_Trees_DamCd) > 1) {
  errors_Trees_DamCd <- errors_Trees_DamCd %>%
    filter(Error != "No Error") %>% 
    arrange(MacroPlot.Name)
} else {
  errors_Trees_DamCd <- errors_Trees_DamCd}
```

### Trees DBH

[Problem]{.underline}: DBH values smaller than sampling parameters or excessively large. DBH values for standing trees do not exist.

[Procedure:]{.underline}

-   Filter to exclude DD trees. Check that DBH ≥ 2.5.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(!CrwnCl %in% c("DD", "BBD", "CUS"))
query <- "Trees DBH" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH")
values_data <- data$DBH
values_valid <- min(2.5)
values_check <- values_data >= values_valid

# Identify errors
errors_Trees_DBH_Min <- qaqc(data, query, query_message, values_check)
```

-   Filter to exclude DD trees. Check that DBH is not excessively large. Check that DBH values for standing trees exist.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Trees_all %>%
  filter(!is.na(DBH))
data_outlier <- rosnerTest(data_temp$DBH)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_DBH <- ifelse(length(outliers) == 0, max(data_temp$DBH), min(outliers) - 1)

# Set parameters 
data <- Trees_data %>% 
  filter(!CrwnCl %in% c("DD", "BBD", "CUS"))
query <- "Trees DBH" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Possible outlier. DBH")
values_data <- data$DBH
values_valid <- max_DBH
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Trees_DBH_Max <- qaqc(data, query, query_message, values_check)
```

#### Combine DBH Errors

```{r}
# Combine
errors_Trees_DBH <- unique(rbind(errors_Trees_DBH_Min, errors_Trees_DBH_Max))

remove(errors_Trees_DBH_Min, errors_Trees_DBH_Max)

if(nrow(errors_Trees_DBH) > 1) {
  errors_Trees_DBH <- errors_Trees_DBH %>%
    filter(Error != "No Error")
} else {
  errors_Trees_DBH <- errors_Trees_DBH}
```

### Trees DD

[Problem]{.underline}: DBH, height, and or crown base height entered for trees that are no longer standing.

[Procedure:]{.underline}

-   Filter for CrwnCl = BBD, CUS, or DD. Check that DBH, Ht, [and]{.underline} LiCrBHt are blank

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(CrwnCl %in% c("DD", "BBD", "CUS"))
data$DBH[is.na(data$DBH)] <- ""
query <- "Trees DD" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. DBH")
values_data <- data$DBH
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DD_DBH <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(CrwnCl %in% c("DD", "BBD", "CUS"))
data$Ht[is.na(data$Ht)] <- ""
query <- "Trees DD" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. Height")
values_data <- data$Ht
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DD_Ht <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(CrwnCl %in% c("DD", "BBD", "CUS"))
data$LiCrBHt[is.na(data$LiCrBHt)] <- ""
query <- "Trees DD" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. Live Crown Base Height")
values_data <- data$LiCrBHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DD_LiCrBHt <- qaqc(data, query, query_message, values_check)
```

#### Combine DD Errors

```{r}
# Combine
errors_Trees_DD <- unique(rbind(errors_Trees_DD_DBH, errors_Trees_DD_Ht, errors_Trees_DD_LiCrBHt))

remove(errors_Trees_DD_DBH, errors_Trees_DD_Ht, errors_Trees_DD_LiCrBHt)

if(nrow(errors_Trees_DD) > 1) {
  errors_Trees_DD <- errors_Trees_DD %>%
    filter(Error != "No Error")
} else {
  errors_Trees_DD <- errors_Trees_DD}
```

### Trees Duplicates

[Problem]{.underline}: Duplicate tree tag numbers entered for a plot visit.

[Procedure:]{.underline}

-   Check for duplicate tree tags across Date, MacroPlot.Name, SubFrac [and]{.underline} TagNo.

```{r}
# Check for tag duplication and store results in new column
data_temp <- Trees_data %>% 
  get_dupes(Date, MacroPlot.Name, SubFrac, TagNo)

# Set parameters 
data <- merge(Trees_data, data_temp, all.x = T)
data$dupe_count[is.na(data$dupe_count)] <- 0
query <- "Trees Duplicates" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Duplicates")
values_data <- data$dupe_count
values_valid <- 0
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Duplicate <- qaqc(data, query, query_message, values_check)
```

### Trees Height

[Problem:]{.underline} Incorrect values entered for height. Standing trees should have height values. Overstory trees should have reasonable height values. Pole trees should correspond to an established height class.

[Procedure:]{.underline}

-   Filter for standing trees. Check that Ht exists.

```{r}
# Set parameters 
data <- Trees_data %>% 
   filter(!CrwnCl %in% c("DD", "BBD", "CUS"))
data$Ht[is.na(data$Ht)] <- ""
query <- "Trees Height" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Standing tree. Height")
values_data <- data$Ht
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Trees_Height_Standing <- qaqc(data, query, query_message, values_check)
```

-   Filter for Overstory trees. Check that Ht is not excessively large.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Trees_all %>%
  filter(!is.na(Ht), DBH > 15.0)
data_outlier <- rosnerTest(data_temp$Ht)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Ht <- ifelse(length(outliers) == 0, max(data_temp$Ht), min(outliers) - 1)

# Set parameters 
data <- Trees_data %>% 
   filter(DBH > 15.0)
query <- "Trees Height" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = overstory. Possible outlier. Height")
values_data <- data$Ht
values_valid <- max_Ht
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Trees_Height_Overstory <- qaqc(data, query, query_message, values_check)
```

-   Filter for Pole trees. Check that Ht = 0.6, 1, 2, 3, 4, 5, 6, 7, 8, 9, or 10 or blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DBH <= 15.0)
query <- "Trees Height" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = pole. Height")
values_data <- data$Ht
values_valid <- c("", 0.6, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_Height_Pole <- qaqc(data, query, query_message, values_check)
```

#### Combine Height Errors

```{r}
# Combine
errors_Trees_Height <- unique(rbind(errors_Trees_Height_Standing, errors_Trees_Height_Overstory, errors_Trees_Height_Pole))

remove(errors_Trees_Height_Standing, errors_Trees_Height_Overstory, errors_Trees_Height_Pole)

if(nrow(errors_Trees_Height) > 1) {
  errors_Trees_Height <- errors_Trees_Height %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Height <- errors_Trees_Height}
```

### Trees LifeForm

[Problem:]{.underline} Species entered that are not trees.

[Procedure:]{.underline}

-   Check that Preferred Lifeform = Tree

```{r}
# Set parameters 
data <- Trees_data
query <- "Trees LifeForm" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Life Form")
values_data <- data$Preferred_Lifeform
values_valid <- "Tree"
values_check <- values_data == values_valid

# Identify errors
errors_Trees_LifeForm <- qaqc(data, query, query_message, values_check)
```

### Trees Non-Post Severity

[Problem]{.underline}: Scorch height, scorch %, and/or char height are entered in sample events other than immediate post for FMH plots. These values should only be collected at immediate post reads.

[Procedure:]{.underline}

-   Filter to exclude all POST reads (01Post, 02Post, etc). Check that CharHt = blank, ScorchHt = blank, [and]{.underline} CrScPct = blank (i.e. no records should appear in the query)

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(!Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"))
data$CharHt[is.na(data$CharHt)] <- ""
query <- "Trees Non-Post Severity" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Non-post read. Char Height")
values_data <- data$CharHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_NonPost_Severity_CharHt <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(!Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"))
data$ScorchHt[is.na(data$ScorchHt)] <- ""
query <- "Trees Non-Post Severity" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Non-post read. Scorch Height")
values_data <- data$ScorchHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_NonPost_Severity_ScorchHt <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(!Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"))
data$CrScPct[is.na(data$CrScPct)] <- ""
query <- "Trees Non-Post Severity" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Non-post read. Crown Scorch Percent")
values_data <- data$CrScPct
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_NonPost_Severity_CrScPct <- qaqc(data, query, query_message, values_check)
```

#### Combine Non-Post Severity Errors

```{r}
# Combine
errors_Trees_NonPost_Severity <- unique(rbind(errors_Trees_NonPost_Severity_CharHt, errors_Trees_NonPost_Severity_ScorchHt, errors_Trees_NonPost_Severity_CrScPct))

remove(errors_Trees_NonPost_Severity_CharHt, errors_Trees_NonPost_Severity_ScorchHt, errors_Trees_NonPost_Severity_CrScPct)

if(nrow(errors_Trees_NonPost_Severity) > 1) {
  errors_Trees_NonPost_Severity <- errors_Trees_NonPost_Severity %>%
    filter(Error != "No Error")
} else {
  errors_Trees_NonPost_Severity <- errors_Trees_NonPost_Severity}
```

### Trees Post Char

[Problem]{.underline}: Char height missing or excessively large for standing trees during the immediate post-fire sample events in FMH plots. Char height entered for trees that are no longer standing.

[Note]{.underline}: Post-burn measurements were not collected on pole-sized trees 1990-2002.

[Procedure:]{.underline}

-   DD trees. Filter to include all POST reads (01Post, 02Post, etc). Filter for DD crown classes (DD, BBD, and CUS). Check that CharHt is blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         CrwnCl %in% c("DD", "BBD", "CUS"))
data$CharHt[is.na(data$CharHt)] <- ""
query <- "Trees Post Char" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. Char Height")
values_data <- data$CharHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Post_Char_DD <- qaqc(data, query, query_message, values_check)
```

-   Standing trees. Filter to include all POST reads (01Post, 02Post, etc). Filter to exclude DD crown classes (DD, BBD, and CUS). Check that CharHt is [not]{.underline} blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !CrwnCl %in% c("DD", "BBD", "CUS"))
data$CharHt[is.na(data$CharHt)] <- ""
query <- "Trees Post Char" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Standing tree. Char Height")
values_data <- data$CharHt
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Trees_Post_Char_Standing <- qaqc(data, query, query_message, values_check)
```

-   Max char. Filter to include all POST reads (01Post, 02Post, etc). Check that CharHt is not excessively high.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Trees_all %>%
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !is.na(CharHt))
data_outlier <- rosnerTest(data_temp$CharHt)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Char <- ifelse(length(outliers) == 0, max(data_temp$CharHt), min(outliers) - 1)

# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !is.na(CharHt))
query <- "Trees Post Char" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Possible outlier. Char Height")
values_data <- data$CharHt
values_valid <- max_Char
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Trees_Post_Char_Max <- qaqc(data, query, query_message, values_check)
```

-   Char vs Ht. Filter to include all POST reads (01Post, 02Post, etc). Check that CharHt \<= Ht.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !is.na(CharHt))
query <- "Trees Post Char" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Height shorter than Char. Char Height")
values_data <- data$CharHt
values_valid <- data$Ht
values_check <- values_data <= values_valid

# Identify errors
errors_Trees_Post_Char_Ht <- qaqc(data, query, query_message, values_check)
```

#### Combine Post Char Errors

```{r}
# Combine
errors_Trees_Post_Char <- unique(rbind(errors_Trees_Post_Char_DD, errors_Trees_Post_Char_Standing, errors_Trees_Post_Char_Max, errors_Trees_Post_Char_Ht))

remove(errors_Trees_Post_Char_DD, errors_Trees_Post_Char_Standing, errors_Trees_Post_Char_Max, errors_Trees_Post_Char_Ht)

if(nrow(errors_Trees_Post_Char) > 1) {
  errors_Trees_Post_Char <- errors_Trees_Post_Char %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Post_Char <- errors_Trees_Post_Char}
```

### Trees Post ScorchHt

[Problem]{.underline}: Scorch height missing or excessively large for live trees during the immediate post-fire sample events in FMH plots. Scorch height entered for trees that are no longer standing or are broken.

[Note]{.underline}: Post-burn measurements were not collected on pole-sized trees 1990-2002.

[Procedure:]{.underline}

-   DD Trees. Filter to include all POST reads (01Post, 02Post, etc). Filter for DD crown classes (DD, BBD, and CUS). Check that ScorchHt = blank.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         CrwnCl %in% c("DD", "BBD", "CUS"))
data$ScorchHt[is.na(data$ScorchHt)] <- ""
query <- "Trees Post Scorch" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. Scorch Height")
values_data <- data$ScorchHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Post_Scorch_DD <- qaqc(data, query, query_message, values_check)
```

-   Standing Dead Trees. Filter to include all POST reads (01Post, 02Post, etc). Filter to exclude DD crown classes (DD, BBD, and CUS). Filter for Status = D. Check that ScorchHt = blank. If ScorchHt is not blank, check that ScorchHt = Ht (100% scorch)

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !CrwnCl %in% c("DD", "BBD", "CUS"),
         Status == "D",
         ScorchHt != Ht)
data$ScorchHt[is.na(data$ScorchHt)] <- ""
query <- "Trees Post Scorch"
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Standing tree. Scorch Height")
values_data <- data$ScorchHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Post_Scorch_Dead <- qaqc(data, query, query_message, values_check)
```

-   Live trees. Filter to include all POST reads (01Post, 02Post, etc). Filter for Status = L. Check that ScorchHt is not blank or excessively high.

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Trees_all %>%
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !is.na(ScorchHt))
data_outlier <- rosnerTest(data_temp$ScorchHt)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_Scorch <- ifelse(length(outliers) == 0, max(data_temp$ScorchHt), min(outliers) - 1)

# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         Status == "L")
query <- "Trees Post Scorch" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Possible outlier. Scorch Height")
values_data <- data$ScorchHt
values_valid <- max_Scorch
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Trees_Post_Scorch_Live <- qaqc(data, query, query_message, values_check)
```

-   Scorch vs Ht. Filter to include all POST reads (01Post, 02Post, etc). Check that ScorchHt \<= Ht.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !is.na(ScorchHt))
query <- "Trees Post Scorch" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Height shorter than Scorch. Scorch Height")
values_data <- data$ScorchHt
values_valid <- data$Ht
values_check <- values_data <= values_valid

# Identify errors
errors_Trees_Post_Scorch_Ht <- qaqc(data, query, query_message, values_check)
```

#### Combine Post ScorchHt Errors

```{r}
# Combine
errors_Trees_Post_ScorchHt <- unique(rbind(errors_Trees_Post_Scorch_DD, errors_Trees_Post_Scorch_Dead, errors_Trees_Post_Scorch_Live, errors_Trees_Post_Scorch_Ht))

remove(errors_Trees_Post_Scorch_DD, errors_Trees_Post_Scorch_Dead, errors_Trees_Post_Scorch_Live, errors_Trees_Post_Scorch_Ht)

if(nrow(errors_Trees_Post_ScorchHt) > 1) {
  errors_Trees_Post_ScorchHt <- errors_Trees_Post_ScorchHt %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Post_ScorchHt <- errors_Trees_Post_ScorchHt}
```

### Trees Post ScorchPct

[Problem]{.underline}: Scorch % missing or excessively large for live trees during the immediate post-fire sample events in FMH plots. Scorch % entered incorrectly for trees that are no longer standing.

[Note]{.underline}: Post-burn measurements were not collected on pole-sized trees 1990-2002.

[Procedure:]{.underline}

-   DD Trees. Filter to include all POST reads (01Post, 02Post, etc). Filter for DD crown classes (DD, BBD, and CUS). Check that CrScPct = blank.

-   Check that all rows with CrwnCl = DD have CrScPct = blank or 100. (RS?)

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         CrwnCl %in% c("DD", "BBD", "CUS"))
data$CrScPct[is.na(data$CrScPct)] <- ""
query <- "Trees Post Scorch%" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Crown Class = DD. Scorch Percent")
values_data <- data$CrScPct
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Post_ScorchPct_DD <- qaqc(data, query, query_message, values_check)
```

-   Standing Dead Trees. Filter to include all POST reads (01Post, 02Post, etc). Filter to exclude DD crown classes (DD, BBD, and CUS). Filter for Status = D. Check that CrScPct = blank or 100.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         !CrwnCl %in% c("DD", "BBD", "CUS"),
         Status == "D")
data$CrScPct[is.na(data$CrScPct)] <- ""
query <- "Trees Post Scorch%"
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = D. Standing tree. Scorch Percent")
values_data <- data$CrScPct
values_valid <- c("", 100)
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_Post_ScorchPct_Dead <- qaqc(data, query, query_message, values_check)
```

-   Live trees. Filter to include all POST reads (01Post, 02Post, etc). Filter for Status = L. Check that CrScPct is not blank. Check that CrScPct ≤ 100.

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(Monitoring.Status %in% c("01Post", "02Post", "03Post", "04Post"),
         Status == "L")
query <- "Trees Post Scorch%" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status = L. Scorch Percent")
values_data <- data$CrScPct
values_valid <- max(100)
values_check <- values_data <= values_valid

# Identify errors
errors_Trees_Post_ScorchPct_Live <- qaqc(data, query, query_message, values_check)
```

#### Combine Post ScorchPct Errors

```{r}
# Combine
errors_Trees_Post_ScorchPct <- unique(rbind(errors_Trees_Post_ScorchPct_DD, errors_Trees_Post_ScorchPct_Dead, errors_Trees_Post_ScorchPct_Live))

remove(errors_Trees_Post_ScorchPct_DD, errors_Trees_Post_ScorchPct_Dead, errors_Trees_Post_ScorchPct_Live)

if(nrow(errors_Trees_Post_ScorchPct) > 1) {
  errors_Trees_Post_ScorchPct <- errors_Trees_Post_ScorchPct %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Post_ScorchPct <- errors_Trees_Post_ScorchPct}
```

### Trees Quarter

[Problem:]{.underline} Incorrect values entered for quarter.

[Procedure:]{.underline}

-   Filter for Overstory Trees. Check that QTR = 1, 2, 3, or 4.

```{r}
# Set parameters 
data <- Trees_data %>% 
   filter(DBH > 15.0)
query <- "Trees Quarter" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = overstory. Quarter")
values_data <- data$QTR
values_valid <- c(1, 2, 3, 4)
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_Quarter_Overstory <- qaqc(data, query, query_message, values_check)
```

-   Filter for Pole trees. Check that QTR = 1 or 2.

```{r}
data <- Trees_data %>% 
  filter(DBH <= 15.0)
query <- "Trees Quarter" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = pole. Quarter")
values_data <- data$QTR
values_valid <- c(1, 2)
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_Quarter_Pole <- qaqc(data, query, query_message, values_check)
```

#### Combine Quarter Errors

```{r}
# Combine
errors_Trees_Quarter <- unique(rbind(errors_Trees_Quarter_Overstory, errors_Trees_Quarter_Pole))

remove(errors_Trees_Quarter_Overstory, errors_Trees_Quarter_Pole)

if(nrow(errors_Trees_Quarter) > 1) {
  errors_Trees_Quarter <- errors_Trees_Quarter %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Quarter <- errors_Trees_Quarter}
```

### Trees Status

[Problem:]{.underline} Species do not have an entry for status or have an entry that we don’t use.

[Procedure:]{.underline}

-   Sort by Status. Check that Status = L or D

```{r}
# Set parameters 
data <- Trees_data
query <- "Trees Status" 
query_message <- paste0("Tag ", data$TagNo, ". ", "Status")
values_data <- data$Status
values_valid <- c("L", "D")
values_check <- values_data %in% values_valid

# Identify errors
errors_Trees_Status <- qaqc(data, query, query_message, values_check)
```

### Trees SubFrac

[Problem:]{.underline} Incorrect subplot fraction entered for trees.

[Note:]{.underline} In some cases pole SubFrac will differ from 0.5 if a smaller area was sampled in a particular year. Check yearly procedures to confirm correct values.

[Procedure:]{.underline}

-   If DBH = overstory, then check that SubFrac = 1

```{r}
# Set parameters 
data <- Trees_data %>% 
   filter(DBH > 15.0)
query <- "Trees SubFrac" 
query_message <- paste0("Tag ", data$TagNo, ". ", "DBH = overstory. Subplot Fraction")
values_data <- data$SubFrac
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_Trees_SubFrac_Overstory <- qaqc(data, query, query_message, values_check)
```

-   If DBH = pole, then check that SubFrac = 0.5

```{r}
# Set parameters 
data <- Trees_data %>% 
  filter(DBH <= 15.0)
query <- "Trees SubFrac" 
query_message <- paste0("DBH = pole. Subplot Fraction")
values_data <- data$SubFrac
values_valid <- 0.5
values_check <- values_data == values_valid

# Identify errors
errors_Trees_SubFrac_Pole <- qaqc(data, query, query_message, values_check)
```

#### Combine SubFrac Errors

```{r}
# Combine
errors_Trees_SubFrac <- unique(rbind(errors_Trees_SubFrac_Overstory, errors_Trees_SubFrac_Pole))

remove(errors_Trees_SubFrac_Overstory, errors_Trees_SubFrac_Pole)

if(nrow(errors_Trees_SubFrac) > 1) {
  errors_Trees_SubFrac <- errors_Trees_SubFrac %>%
    filter(Error != "No Error")
} else {
  errors_Trees_SubFrac <- errors_Trees_SubFrac}
```

### Trees UV

[Problem]{.underline}: X present in the UV columns signifying respective data (DBH, Ht, or LiCrBHT) weren’t assessed.

[Procedure]{.underline}:

-   Check that UV(1, 2, [or]{.underline} 3) is blank for all plots

```{r}
# Set parameters 
data <- Trees_data
data$UV1[is.na(data$UV1)] <- ""
query <- "Trees UV1" 
query_message <- paste0("Tag ", data$TagNo, ". ", "User Variable 1")
values_data <- data$UV1
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_UV1 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data
data$UV2[is.na(data$UV2)] <- ""
query <- "Trees UV2" 
query_message <- paste0("Tag ", data$TagNo, ". ", "User Variable 2")
values_data <- data$UV2
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_UV2 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- Trees_data
data$UV3[is.na(data$UV3)] <- ""
query <- "Trees UV3" 
query_message <- paste0("Tag ", data$TagNo, ". ", "User Variable 3")
values_data <- data$UV3
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_UV3 <- qaqc(data, query, query_message, values_check)
```

#### Combine UV Errors

```{r}
# Combine
errors_Trees_UV <- unique(rbind(errors_Trees_UV1, errors_Trees_UV2, errors_Trees_UV3))

remove(errors_Trees_UV1, errors_Trees_UV2, errors_Trees_UV3)
```

## Trees Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that Age = blank

```{r}
# Set parameters
data <- Trees_data
data$Age[is.na(data$Age)] <- ""
query <- "Trees Zero/NA"
query_message <- "Age"
values_data <- data$Age
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Age <- qaqc(data, query, query_message, values_check)
```

-   Check that CKR = blank

```{r}
# Set parameters
data <- Trees_data
data$CKR[is.na(data$CKR)] <- ""
query <- "Trees Zero/NA"
query_message <- "CKR (Cambium Kill Rating)"
values_data <- data$CKR
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CKR <- qaqc(data, query, query_message, values_check)
```

-   Check that CrFuBHt = blank

```{r}
# Set parameters
data <- Trees_data
data$CrFuBHt[is.na(data$CrFuBHt)] <- ""
query <- "Trees Zero/NA"
query_message <- "Crown Fuel Base Height"
values_data <- data$CrFuBHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CrFuBHt <- qaqc(data, query, query_message, values_check)
```

-   Check that CrwnRad = blank

```{r}
# Set parameters
data <- Trees_data
data$CrwnRad[is.na(data$CrwnRad)] <- ""
query <- "Trees Zero/NA"
query_message <- "Crown Radius"
values_data <- data$CrwnRad
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CrwnRad <- qaqc(data, query, query_message, values_check)
```

-   Check that CrwnRto = blank

```{r}
# Set parameters
data <- Trees_data
data$CrwnRto[is.na(data$CrwnRto)] <- ""
query <- "Trees Zero/NA"
query_message <- "Crown Ratio"
values_data <- data$CrwnRto
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_CrwnRto <- qaqc(data, query, query_message, values_check)
```

-   Check that DamSev (1-5) = blank

```{r}
# Set parameters
data <- Trees_data
data$DamSev1[is.na(data$DamSev1)] <- ""
query <- "Trees Zero/NA"
query_message <- "Damage Severity 1"
values_data <- data$DamSev1
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DamSev1 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters
data <- Trees_data
data$DamSev2[is.na(data$DamSev2)] <- ""
query <- "Trees Zero/NA"
query_message <- "Damage Severity 2"
values_data <- data$DamSev2
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DamSev2 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters
data <- Trees_data
data$DamSev3[is.na(data$DamSev3)] <- ""
query <- "Trees Zero/NA"
query_message <- "Damage Severity 3"
values_data <- data$DamSev3
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DamSev3 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters
data <- Trees_data
data$DamSev4[is.na(data$DamSev4)] <- ""
query <- "Trees Zero/NA"
query_message <- "Damage Severity 4"
values_data <- data$DamSev4
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DamSev4 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Set parameters
data <- Trees_data
data$DamSev5[is.na(data$DamSev5)] <- ""
query <- "Trees Zero/NA"
query_message <- "Damage Severity 5"
values_data <- data$DamSev5
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DamSev5 <- qaqc(data, query, query_message, values_check)
```

```{r}
# Combine DamSev Errors
errors_Trees_DamSev <- unique(rbind(errors_Trees_DamSev1, errors_Trees_DamSev2, errors_Trees_DamSev3, errors_Trees_DamSev4, errors_Trees_DamSev5))

remove(errors_Trees_DamSev1, errors_Trees_DamSev2, errors_Trees_DamSev3, errors_Trees_DamSev4, errors_Trees_DamSev5)
```

-   Check that DecayCl = blank

```{r}
# Set parameters
data <- Trees_data
data$DecayCl[is.na(data$DecayCl)] <- ""
query <- "Trees Zero/NA"
query_message <- "Decay Class"
values_data <- data$DecayCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DecayCl <- qaqc(data, query, query_message, values_check)
```

-   Check that DRC = blank

```{r}
# Set parameters
data <- Trees_data
data$DRC[is.na(data$DRC)] <- ""
query <- "Trees Zero/NA"
query_message <- "DRC (Diameter at Root Collar)"
values_data <- data$DRC
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_DRC <- qaqc(data, query, query_message, values_check)
```

-   Check that EqDia = blank

```{r}
# Set parameters
data <- Trees_data
data$EqDia[is.na(data$EqDia)] <- ""
query <- "Trees Zero/NA"
query_message <- "Eq Diameter"
values_data <- data$EqDia
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_EqDia <- qaqc(data, query, query_message, values_check)
```

-   Check that GrwthRt = blank

```{r}
# Set parameters
data <- Trees_data
data$GrwthRt[is.na(data$GrwthRt)] <- ""
query <- "Trees Zero/NA"
query_message <- "Growth Rate"
values_data <- data$GrwthRt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_GrwthRt <- qaqc(data, query, query_message, values_check)
```

-   Check that LaddBaseHt = blank

```{r}
# Set parameters
data <- Trees_data
data$LaddBaseHt[is.na(data$LaddBaseHt)] <- ""
query <- "Trees Zero/NA"
query_message <- "Ladder Base Height"
values_data <- data$LaddBaseHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_LaddBaseHt <- qaqc(data, query, query_message, values_check)
```

-   Check that LaddMaxHt = blank

```{r}
# Set parameters
data <- Trees_data
data$LaddMaxHt[is.na(data$LaddMaxHt)] <- ""
query <- "Trees Zero/NA"
query_message <- "Ladder Max Height"
values_data <- data$LaddMaxHt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_LaddMaxHt <- qaqc(data, query, query_message, values_check)
```

-   Check that Mort = blank

```{r}
# Set parameters
data <- Trees_data
data$Mort[is.na(data$Mort)] <- ""
query <- "Trees Zero/NA"
query_message <- "Mortality"
values_data <- data$Mort
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_Mort <- qaqc(data, query, query_message, values_check)
```

-   Check that NuDeStems = blank

```{r}
# Set parameters
data <- Trees_data
data$NuDeStems[is.na(data$NuDeStems)] <- ""
query <- "Trees Zero/NA"
query_message <- "Number of Dead Stems"
values_data <- data$NuDeStems
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_NuDeStems <- qaqc(data, query, query_message, values_check)
```

-   Check that NuLiStems = blank

```{r}
# Set parameters
data <- Trees_data
data$NuLiStems[is.na(data$NuLiStems)] <- ""
query <- "Trees Zero/NA"
query_message <- "Number of Live Stems"
values_data <- data$NuLiStems
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_NuLiStems <- qaqc(data, query, query_message, values_check)
```

-   Check that XCoord = blank

```{r}
# Set parameters
data <- Trees_data
data$XCoord[is.na(data$XCoord)] <- ""
query <- "Trees Zero/NA"
query_message <- "X Coordinate"
values_data <- data$XCoord
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_XCoord <- qaqc(data, query, query_message, values_check)
```

-   Check that Ycoord = blank

```{r}
# Set parameters
data <- Trees_data
data$YCoord[is.na(data$YCoord)] <- ""
query <- "Trees Zero/NA"
query_message <- "Y Coordinate"
values_data <- data$YCoord
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Trees_YCoord <- qaqc(data, query, query_message, values_check)
```

#### Combine Zero Errors

```{r}
errors_Trees_Zero <- unique(rbind(errors_Trees_Age, errors_Trees_CKR, errors_Trees_CrFuBHt, errors_Trees_CrwnRad, errors_Trees_CrwnRto, errors_Trees_DamSev, errors_Trees_DecayCl, errors_Trees_DRC, errors_Trees_EqDia, errors_Trees_GrwthRt, errors_Trees_LaddBaseHt, errors_Trees_LaddMaxHt, errors_Trees_Mort, errors_Trees_NuDeStems, errors_Trees_NuLiStems, errors_Trees_XCoord, errors_Trees_YCoord))

remove(errors_Trees_Age, errors_Trees_CKR, errors_Trees_CrFuBHt, errors_Trees_CrwnRad, errors_Trees_CrwnRto, errors_Trees_DamSev, errors_Trees_DecayCl, errors_Trees_DRC, errors_Trees_EqDia, errors_Trees_GrwthRt, errors_Trees_LaddBaseHt, errors_Trees_LaddMaxHt, errors_Trees_Mort, errors_Trees_NuDeStems, errors_Trees_NuLiStems, errors_Trees_XCoord, errors_Trees_YCoord)

if(nrow(errors_Trees_Zero) > 1) {
  errors_Trees_Zero <- errors_Trees_Zero %>%
    filter(Error != "No Error")
} else {
  errors_Trees_Zero <- errors_Trees_Zero}
```

## Trees Errors

```{r}
# errors_Trees <- unique(rbind(errors_Trees_Complete, errors_Trees_Header, errors_Trees_CBH, errors_Trees_CrwnCl, errors_Trees_DamCd, errors_Trees_DBH, errors_Trees_DD, errors_Trees_Duplicate, errors_Trees_Height, errors_Trees_LifeForm, errors_Trees_NonPost_Severity, errors_Trees_Post_Char, errors_Trees_Post_ScorchHt, errors_Trees_Post_ScorchPct, errors_Trees_Quarter, errors_Trees_Status, errors_Trees_SubFrac, errors_Trees_UV))

errors_Trees <- rbind(errors_Trees_Complete, errors_blank, errors_Trees_Header, errors_blank, errors_Trees_CBH, errors_blank, errors_Trees_CrwnCl, errors_blank, errors_Trees_DamCd, errors_blank, errors_Trees_DBH, errors_blank, errors_Trees_DD, errors_blank, errors_Trees_Duplicate, errors_blank, errors_Trees_Height, errors_blank, errors_Trees_LifeForm, errors_blank, errors_Trees_NonPost_Severity, errors_blank, errors_Trees_Post_Char, errors_blank, errors_Trees_Post_ScorchHt, errors_blank, errors_Trees_Post_ScorchPct, errors_blank, errors_Trees_Quarter, errors_blank, errors_Trees_Status, errors_blank, errors_Trees_SubFrac, errors_blank, errors_Trees_UV, errors_blank, errors_Trees_Zero)

remove(errors_Trees_Complete, errors_Trees_Header, errors_Trees_CBH, errors_Trees_CrwnCl, errors_Trees_DamCd, errors_Trees_DBH, errors_Trees_DD, errors_Trees_Duplicate, errors_Trees_Height, errors_Trees_LifeForm, errors_Trees_NonPost_Severity, errors_Trees_Post_Char, errors_Trees_Post_ScorchHt, errors_Trees_Post_ScorchPct, errors_Trees_Quarter, errors_Trees_Status, errors_Trees_SubFrac, errors_Trees_UV, errors_Trees_Zero)
```

```{r}
# Table of results for quick check
#kable(errors_Trees, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_Trees, paste0(path_errors, "errors_GRCA_FMH_Trees.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_Trees, paste0(path_errors, "errors_GRCA_FMH_Trees.xlsx"))
```

# PROTOCOL - SEEDLINGS

This code conducts quality control checks on seedling data within the "Density - Quadrats (metric)" data set.

It checks for errors in: headers, seedling counts, subplot fractions, heights, status, and life form.

### Seedlings Complete

[Problem:]{.underline} Missing data points in FMH plots. Plots with no seedlings should be verified.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits \> 0

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- Seedlings_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- Seedlings_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(Seedlings_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Dens Quad Complete" 
query_message <- "Seedlings" 
values_data <- data$sum_hits
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_Seedlings_Complete <- qaqc(data, query, query_message, values_check)
```

### Seedlings Header

[Problem:]{.underline} Incorrect header information entered for FMH plots.

[Procedure:]{.underline}

-   Filter for PIED, PIPO, and PIPN plots. Check that Area = 250

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIED", "PIPO", "PIPN"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 250. Area")
values_data <- data$Area
values_valid <- 250
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_Area_1 <- qaqc(data, query, query_message, values_check)
```

-   Filter for PIEN and PIAB plots. Check that Area = 50

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIEN", "PIAB"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 50. Area")
values_data <- data$Area
values_valid <- 50
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_Area_2 <- qaqc(data, query, query_message, values_check)
```

-   Filter for PIED, PIPO, and PIPN plots. Check that QuadWid = 25

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIED", "PIPO", "PIPN"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 25. Quad Width")
values_data <- data$QuadWid
values_valid <- 25
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_QuadWid_1 <- qaqc(data, query, query_message, values_check)
```

-   Filter for PIEN and PIAB plots. Check that QuadWid = 10

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIEN", "PIAB"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 10. Quad Width")
values_data <- data$QuadWid
values_valid <- 10
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_QuadWid_2 <- qaqc(data, query, query_message, values_check)
```

-   Filter for PIED, PIPO, and PIPN plots. Check that QuadLen = 10

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIED", "PIPO", "PIPN"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 10. Quad Length")
values_data <- data$QuadLen
values_valid <- 10
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_QuadLen_1 <- qaqc(data, query, query_message, values_check)
```

-   Filter for PIEN and PIAB plots. Check that QuadLen = 5

```{r}
# Set parameters 
data <- Seedlings_header %>% 
  filter(MacroPlot.Purpose %in% c("PIEN", "PIAB"))
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 5. Quad Length")
values_data <- data$QuadLen
values_valid <- 5
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_QuadLen_2 <- qaqc(data, query, query_message, values_check)
```

-   Check that NumTran = 1

```{r}
# Set parameters 
data <- Seedlings_header
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 1. Number of Transects")
values_data <- data$NumTran
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that NumQuadTran = 1

```{r}
# Set parameters 
data <- Seedlings_header
query <- "Dens Quad Header" 
query_message <- paste0("Correct Value = 1. Number Quad Transects")
values_data <- data$NumQuadTran
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_NumQuadTran <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Seedlings_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Dens Quad Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Seedlings_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Seedlings_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Dens Quad Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Seedlings_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
errors_Seedlings_Header <- unique(rbind(errors_Seedlings_Area_1, errors_Seedlings_Area_2, errors_Seedlings_QuadWid_1, errors_Seedlings_QuadWid_2, errors_Seedlings_QuadLen_1, errors_Seedlings_QuadLen_2, errors_Seedlings_NumTran, errors_Seedlings_NumQuadTran, errors_Seedlings_FieldTeam, errors_Seedlings_EntryTeam))

remove(errors_Seedlings_Area_1, errors_Seedlings_Area_2, errors_Seedlings_QuadWid_1, errors_Seedlings_QuadWid_2, errors_Seedlings_QuadLen_1, errors_Seedlings_QuadLen_2, errors_Seedlings_NumTran, errors_Seedlings_NumQuadTran, errors_Seedlings_FieldTeam, errors_Seedlings_EntryTeam)

if(nrow(errors_Seedlings_Header) > 1) {
  errors_Seedlings_Header <- errors_Seedlings_Header %>%
    filter(Error != "No Error")
} else {
  errors_Seedlings_Header <- errors_Seedlings_Header}
```

### Seedlings Count

[Problem:]{.underline} Seedling count values missing, zero, or excessively high (\>100 is possible, but should be verified).

[Procedure:]{.underline}

-   Check that Count is not blank or 0

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Count" 
query_message <- paste0("Count")
values_data <- data$Count
values_valid <- 1
values_check <- values_data >= values_valid

# Identify errors
errors_Seedlings_Count_Min <- qaqc(data, query, query_message, values_check)
```

-   Check that Count is not excessively high

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Seedlings_all %>%
  filter(!is.na(Count))
data_outlier <- rosnerTest(data_temp$Count)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_SeedCount <- ifelse(length(outliers) == 0, max(data_temp$Count), min(outliers) - 1)

# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Count" 
query_message <- paste0("Possible outlier. Count")
values_data <- data$Count
values_valid <- max_SeedCount
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Seedlings_Count_Max <- qaqc(data, query, query_message, values_check)
```

#### Combine Count Errors

```{r}
errors_Seedlings_Count <- unique(rbind(errors_Seedlings_Count_Min, errors_Seedlings_Count_Max))

remove(errors_Seedlings_Count_Min, errors_Seedlings_Count_Max)

if(nrow(errors_Seedlings_Count) > 1) {
  errors_Seedlings_Count <- errors_Seedlings_Count %>%
    filter(Error != "No Error")
} else {
  errors_Seedlings_Count <- errors_Seedlings_Count}
```

### Seedlings Height

[Problem:]{.underline} Incorrect values entered for height or height values missing.

[Procedure:]{.underline}

-   Sort by Height. Check that Height = 0.6, 1, 2, 3, 4, 5, 6, 7, 8, 9, or 10

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Height" 
query_message <- paste0("SubFrac = ", data$SubFrac, ". ", "Species = ", data$Species.Symbol, ". ", "Height")
values_data <- data$Height
values_valid <- c(0.6, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
values_check <- values_data %in% values_valid

# Identify errors
errors_Seedlings_Height <- qaqc(data, query, query_message, values_check)
```

### Seedlings LifeForm

[Problem:]{.underline} Species entered that are not trees.

[Procedure:]{.underline}

-   Check that Preferred Lifeform = Tree

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad LifeForm" 
query_message <- paste0("Life Form")
values_data <- data$Preferred_Lifeform
values_valid <- "Tree"
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_LifeForm <- qaqc(data, query, query_message, values_check)
```

### Seedlings Quadrat

[Problem:]{.underline} Incorrect values entered for quadrat.

[Procedure:]{.underline}

-   Check that Quadrat = 1

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Quadrat" 
query_message <- paste0("Quadrat")
values_data <- data$Quadrat
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_Quadrat <- qaqc(data, query, query_message, values_check)
```

### Seedlings Status

[Problem:]{.underline} Species do not have an entry for status or have an entry that we don’t use.

[Procedure:]{.underline}

-   Sort by Status. Check that Status = L

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Status" 
query_message <- paste0("Species ", data$Species.Symbol, ". ", "Status")
values_data <- data$Status
values_valid <- c("L")
values_check <- values_data %in% values_valid

# Identify errors
errors_Seedlings_Status <- qaqc(data, query, query_message, values_check)
```

### Seedlings SubFrac

[Problem:]{.underline} Incorrect subplot fraction entered or subplot fraction missing for FMH plots.

[Procedure:]{.underline}

-   Check that SubFrac = 1

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad SubFrac" 
query_message <- paste0("Subplot Fraction")
values_data <- data$SubFrac
values_valid <- c(1)
values_check <- values_data %in% values_valid

# Identify errors
errors_Seedlings_SubFrac <- qaqc(data, query, query_message, values_check)
```

### Seedlings Transect

[Problem:]{.underline} Incorrect values entered for transect.

[Procedure:]{.underline}

-   Check that Transect = 1

```{r}
# Set parameters 
data <- Seedlings_data
query <- "Dens Quad Transect" 
query_message <- paste0("Transect")
values_data <- data$Transect
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_Transect <- qaqc(data, query, query_message, values_check)
```

### Seedlings Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that AgeCl = blank

```{r}
# Set parameters
data <- Seedlings_data
data$AgeCl[is.na(data$AgeCl)] <- ""
query <- "Dens Quad Zero/NA"
query_message <- "Age Class"
values_data <- data$AgeCl
values_valid <- c("", "X")
values_check <- values_data %in% values_valid

# Identify errors
errors_Seedlings_AgeCl <- qaqc(data, query, query_message, values_check)
```

-   Check that SizeCl = blank

```{r}
# Set parameters
data <- Seedlings_data
data$SizeCl[is.na(data$SizeCl)] <- ""
query <- "Dens Quad Zero/NA"
query_message <- "Size Class"
values_data <- data$SizeCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Seedlings_SizeCl <- qaqc(data, query, query_message, values_check)
```

#### Combine Zero Errors

```{r}
errors_Seedlings_Zero <- unique(rbind(errors_Seedlings_AgeCl, errors_Seedlings_SizeCl))

remove(errors_Seedlings_AgeCl, errors_Seedlings_SizeCl)

if(nrow(errors_Seedlings_Zero) > 1) {
  errors_Seedlings_Zero <- errors_Seedlings_Zero %>%
    filter(Error != "No Error")
} else {
  errors_Seedlings_Zero <- errors_Seedlings_Zero}
```

### Seedlings Errors

```{r}
errors_Seedlings <- rbind(errors_Seedlings_Complete, errors_blank, errors_Seedlings_Header, errors_blank, errors_Seedlings_Count, errors_blank, errors_Seedlings_Height, errors_blank, errors_Seedlings_LifeForm,  errors_blank, errors_Seedlings_Quadrat, errors_blank, errors_Seedlings_Status, errors_blank, errors_Seedlings_SubFrac, errors_blank, errors_Seedlings_Transect, errors_blank, errors_Seedlings_Zero)

remove(errors_Seedlings_Complete, errors_Seedlings_Header, errors_Seedlings_Count, errors_Seedlings_Height, errors_Seedlings_LifeForm, errors_Seedlings_Quadrat, errors_Seedlings_Status, errors_Seedlings_SubFrac, errors_Seedlings_Transect, errors_Seedlings_Zero)
```

```{r}
# Table of results for quick check
#kable(errors_Seedlings, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_Seedlings, paste0(path_errors, "errors_GRCA_FMH_Seedlings.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_Seedlings, paste0(path_errors, "errors_GRCA_FMH_Seedlings.xlsx"))
```

# PROTOCOL - SHRUBS

This code conducts quality control checks on shrub data within the "Density - Belts (metric)" data set.

It checks for errors in: heades, age class, shrub counts, life form, status, subbelt, subplot fraction, and transect.

### Shrubs Complete

[Problem:]{.underline} Missing data points in FMH plots. Plots with no shrubs should be verified.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits \> 0

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- Shrubs_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- Shrubs_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(Shrubs_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Dens Belts Complete" 
query_message <- "Shrubs" 
values_data <- data$sum_hits
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_Shrubs_Complete <- qaqc(data, query, query_message, values_check)
```

### Shrubs Header

[Problem:]{.underline} Incorrect header information entered.

[Procedure:]{.underline}

-   Check that NumTran = 2

```{r}
# Set parameters 
data <- Shrubs_header
query <- "Dens Belts Header" 
query_message <- paste0("Number of Transects")
values_data <- data$NumTran
values_valid <- 2
values_check <- values_data == values_valid

# Identify errors
errors_Shrubs_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that TranLen = 50

```{r}
# Set parameters 
data <- Shrubs_header
query <- "Dens Belts Header" 
query_message <- paste0("Transect Length")
values_data <- data$TranLen 
values_valid <- 50  
values_check <-values_data == values_valid

# Identify errors
errors_Shrubs_TranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that TranWid = 2

```{r}
# Set parameters 
data <- Shrubs_header
query <- "Dens Belts Header" 
query_message <- paste0("Transect Width")
values_data <- data$TranWid
values_valid <- 2
values_check <-values_data == values_valid

# Identify errors
errors_Shrubs_TranWid <- qaqc(data, query, query_message, values_check)
```

-   Check that Area = 100

```{r}
# Set parameters 
data <- Shrubs_header
query <- "Dens Belts Header" 
query_message <- paste0("Area")
values_data <- data$Area
values_valid <- 100
values_check <- values_data == values_valid

# Identify errors
errors_Shrubs_Area <- qaqc(data, query, query_message, values_check)
```

-   Check that NumSubBelt is blank

```{r}
# Set parameters 
data <- Shrubs_header
data$NumSubbelt[is.na(data$NumSubbelt)] <- ""
query <- "Dens Belts Header" 
query_message <- paste0("Number of SubBelts")
values_data <- data$NumSubbelt
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Shrubs_NumSubBelt <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Shrubs_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Dens Belts Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Shrubs_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- Shrubs_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Dens Belts Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_Shrubs_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
errors_Shrubs_Header <- unique(rbind(errors_Shrubs_NumTran, errors_Shrubs_TranLen, errors_Shrubs_TranWid, errors_Shrubs_Area, errors_Shrubs_NumSubBelt, errors_Shrubs_FieldTeam, errors_Shrubs_EntryTeam))

remove(errors_Shrubs_NumTran, errors_Shrubs_TranLen, errors_Shrubs_TranWid, errors_Shrubs_Area, errors_Shrubs_NumSubBelt, errors_Shrubs_FieldTeam, errors_Shrubs_EntryTeam)

if(nrow(errors_Shrubs_Header) > 1) {
  errors_Shrubs_Header <- errors_Shrubs_Header %>%
    filter(Error != "No Error")
} else {
  errors_Shrubs_Header <- errors_Shrubs_Header}
```

### Shrubs AgeCl

[Problem:]{.underline} Species do not have an entry for age class or have an entry that we don’t use.

[Procedure:]{.underline}

-   Check that AgeCl = I or M

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts AgeCl" 
query_message <- paste0("Transect = ", data$Transect, ". ", "SubBelt = ", data$Subbelt, ". ", "Age Class")
values_data <- data$AgeCl
values_valid <- c("I", "M")
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_AgeCl <- qaqc(data, query, query_message, values_check)
```

### Shrubs Count

[Problem:]{.underline} Count values missing, zero, or excessively high (\>100 is possible, but should be verified).

[Procedure:]{.underline}

-   Check that Count is not blank or 0

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts Count" 
query_message <- paste0("Count")
values_data <- data$Count
values_valid <- 1
values_check <- values_data >= values_valid

# Identify errors
errors_Shrubs_Count_Min <- qaqc(data, query, query_message, values_check)
```

-   Check that Count is not excessively high

```{r}
# Perform Rosner's Test for outliers using all values
data_temp <- Shrubs_all %>%
  filter(!is.na(Count))
data_outlier <- rosnerTest(data_temp$Count)
outliers <- data_outlier$all.stats$Value[data_outlier$all.stats$Outlier]
max_ShrubCount <- ifelse(length(outliers) == 0, max(data_temp$Count), min(outliers) - 1)

# Set parameters 
data <- Shrubs_data
query <- "Dens Belts Count" 
query_message <- paste0("Possible outlier. Count")
values_data <- data$Count
values_valid <- max_ShrubCount
values_check <- (values_data <= values_valid) %>% replace_na(TRUE)

# Identify errors
errors_Shrubs_Count_Max <- qaqc(data, query, query_message, values_check)
```

#### Combine Count Errors

```{r}
errors_Shrubs_Count <- unique(rbind(errors_Shrubs_Count_Min, errors_Shrubs_Count_Max))

remove(errors_Shrubs_Count_Min, errors_Shrubs_Count_Max)

if(nrow(errors_Shrubs_Count) > 1) {
  errors_Shrubs_Count <- errors_Shrubs_Count %>%
    filter(Error != "No Error")
} else {
  errors_Shrubs_Count <- errors_Shrubs_Count}
```

### Shrubs LifeForm

[Problem:]{.underline} Species entered that are not shrubs.

[Procedure:]{.underline}

-   Check that Preferred Lifeform = Shrub or Subshrub

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts LifeForm" 
query_message <- paste0("Life Form")
values_data <- data$Preferred_Lifeform
values_valid <- c("Shrub", "Subshrub")
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_LifeForm <- qaqc(data, query, query_message, values_check)
```

### Shrubs Status

[Problem:]{.underline} Species do not have an entry for status or have an entry that we don’t use.

[Procedure:]{.underline}

-   Check that Status = L

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts Status" 
query_message <- paste0("Transect = ", data$Transect, ". ", "SubBelt = ", data$Subbelt, ". ", "Status")
values_data <- data$Status
values_valid <- c("L")
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_Status <- qaqc(data, query, query_message, values_check)
```

### Shrubs SubBelt

[Problem:]{.underline} Incorrect subbelt values entered or subbelt values missing.

[Procedure:]{.underline}

-   Check that Subbelt = 1, 2, 3, 4, 5, 6, 7, 8, 9, or 10

```{r}
# Set parameters
data <- Shrubs_data
query <- "Dens Belts SubBelt"
query_message <- paste0("Transect = ", data$Transect, ". ", "SubBelt")
values_data <- data$Subbelt
values_valid <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_SubBelt <- qaqc(data, query, query_message, values_check)
```

### Shrubs SubFrac

[Problem:]{.underline} Subplot fraction missing or incorrect.

[Procedure:]{.underline}

-   Check that SubFrac = 1

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts SubFrac" 
query_message <- paste0("Subplot Fraction")
values_data <- data$SubFrac
values_valid <- c(1)
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_SubFrac <- qaqc(data, query, query_message, values_check)
```

### Shrubs Transect

[Problem:]{.underline} Incorrect transect numbers entered or transect number missing.

[Procedure:]{.underline}

-   Check that Transect = 1 or 2

```{r}
# Set parameters 
data <- Shrubs_data
query <- "Dens Belts Transect" 
query_message <- paste0("Transect")
values_data <- data$Transect
values_valid <- c(1, 2)
values_check <- values_data %in% values_valid

# Identify errors
errors_Shrubs_Transect <- qaqc(data, query, query_message, values_check)
```

### Shrubs Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that Height = blank

```{r}
# Set parameters
data <- Shrubs_data
data$Height[is.na(data$Height)] <- ""
query <- "Dens Belts Zero/NA"
query_message <- "Height"
values_data <- data$Height
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Shrubs_Height <- qaqc(data, query, query_message, values_check)
```

-   Check that SizeCl = blank

```{r}
# Set parameters
data <- Shrubs_data
data$SizeCl[is.na(data$SizeCl)] <- ""
query <- "Dens Belts Zero/NA"
query_message <- "Size Class"
values_data <- data$SizeCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_Shrubs_SizeCl <- qaqc(data, query, query_message, values_check)
```

#### Combine Zero Errors

```{r}
errors_Shrubs_Zero <- unique(rbind(errors_Shrubs_Height, errors_Shrubs_SizeCl))

remove(errors_Shrubs_Height, errors_Shrubs_SizeCl)

if(nrow(errors_Shrubs_Zero) > 1) {
  errors_Shrubs_Zero <- errors_Shrubs_Zero %>%
    filter(Error != "No Error")
} else {
  errors_Shrubs_Zero <- errors_Shrubs_Zero}
```

### Shrubs Errors

```{r}
errors_Shrubs <- rbind(errors_Shrubs_Complete, errors_blank, errors_Shrubs_Header, errors_blank, errors_Shrubs_AgeCl, errors_blank, errors_Shrubs_Count, errors_blank, errors_Shrubs_LifeForm, errors_blank, errors_Shrubs_Status, errors_blank, errors_Shrubs_SubBelt, errors_blank, errors_Shrubs_SubFrac, errors_blank, errors_Shrubs_Transect, errors_blank, errors_Shrubs_Zero)

remove(errors_Shrubs_Complete, errors_Shrubs_Header, errors_Shrubs_AgeCl, errors_Shrubs_Count, errors_Shrubs_LifeForm, errors_Shrubs_Status, errors_Shrubs_SubBelt, errors_Shrubs_SubFrac, errors_Shrubs_Transect, errors_Shrubs_Zero)
```

```{r}
# Table of results for quick check
#kable(errors_Shrubs, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_Shrubs, paste0(path_errors, "errors_GRCA_FMH_Shrubs.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_Shrubs, paste0(path_errors, "errors_GRCA_FMH_Shrubs.xlsx"))
```

# PROTOCOL - HERBS OBS

This code conducts quality control checks on observed herbaceous data within the "Cover - Species Composition (metric)" data set.

It checks for errors in: cover, species, and status.

### HerbsObs Complete

[Problem:]{.underline} Missing data points in FMH plots. Plots with no observed herbs should be verified.

[Procedure:]{.underline}

-   Group by Macroplot and Date. Calculate number of hits per plot. Check that sum_hits \> 0

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- HerbsObs_data %>%
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- HerbsObs_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(HerbsObs_data, data_temp, by = c("MacroPlot.Name", "Date"), all = T)
query <- "Cvr SpComp Complete" 
query_message <- "Species" 
values_data <- data$sum_hits
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_HerbsObs_Complete <- qaqc(data, query, query_message, values_check)
```

### HerbsObs Header

[Problem:]{.underline} Incorrect header information entered.

[Procedure:]{.underline}

-   Check that MinCovLevel is blank

```{r}
# Set parameters  
data <- HerbsObs_header
data$MinCovLevel[is.na(data$MinCovLevel)] <- ""
query <- "Cvr SpComp Header" 
query_message <- "Min Cover Level"  
values_data <- data$MinCovLevel
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_MinCovLevel <- qaqc(data, query, query_message, values_check)
```

-   Check that Area is blank

```{r}
# Set parameters  
data <- HerbsObs_header
data$Area[is.na(data$Area)] <- ""
query <- "Cvr SpComp Header" 
query_message <- "Area"  
values_data <- data$Area
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_Area <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- HerbsObs_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Cvr SpComp Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_HerbsObs_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- HerbsObs_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Cvr SpComp Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_HerbsObs_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
errors_HerbsObs_Header <- unique(rbind(errors_HerbsObs_MinCovLevel, errors_HerbsObs_Area, errors_HerbsObs_FieldTeam, errors_HerbsObs_EntryTeam))

remove(errors_HerbsObs_MinCovLevel, errors_HerbsObs_Area, errors_HerbsObs_FieldTeam, errors_HerbsObs_EntryTeam)

if(nrow(errors_HerbsObs_Header) > 1) {
  errors_HerbsObs_Header <- errors_HerbsObs_Header %>%
    filter(Error != "No Error")
} else {
  errors_HerbsObs_Header <- errors_HerbsObs_Header}
```

### HerbsObs Cover

[Problem:]{.underline} Cover values are entered for herbaceous species in FMH plots.

[Procedure:]{.underline}

-   Check that Cover = blank

```{r}
# Set parameters
data <- HerbsObs_data
data$Cover[is.na(data$Cover)] <- ""
query <- "Cvr SpComp Cvr"
query_message <- paste0("Cover")
values_data <- data$Cover
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_Cover <- qaqc(data, query, query_message, values_check)
```

### HerbsObs Status

[Problem:]{.underline} Species do not have an entry for status or have an entry that we don’t use.

[Procedure:]{.underline}

-   Sort by Status. Check that Status = L

```{r}
# Set parameters 
data <- HerbsObs_data
query <- "Cvr SpComp Status" 
query_message <- paste0("Species ", data$Species.Symbol, ". ", "Status")
values_data <- data$Status
values_valid <- c("L")
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsObs_Status <- qaqc(data, query, query_message, values_check)
```

### HerbsObs Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that AgeCl = blank

```{r}
# Set parameters
data <- HerbsObs_data
data$AgeCl[is.na(data$AgeCl)] <- ""
query <- "Cvr SpComp Zero/NA"
query_message <- "Age Class"
values_data <- data$AgeCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_AgeCl <- qaqc(data, query, query_message, values_check)
```

-   Check that Height = blank

```{r}
# Set parameters
data <- HerbsObs_data
data$Height[is.na(data$Height)] <- ""
query <- "Cvr SpComp Zero/NA"
query_message <- "Height"
values_data <- data$Height
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_Height <- qaqc(data, query, query_message, values_check)
```

-   Check that SizeCl = blank

```{r}
# Set parameters
data <- HerbsObs_data
data$SizeCl[is.na(data$SizeCl)] <- ""
query <- "Cvr SpComp Zero/NA"
query_message <- "Size Class"
values_data <- data$SizeCl
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsObs_SizeCl <- qaqc(data, query, query_message, values_check)
```

#### Combine Zero Errors

```{r}
errors_HerbsObs_Zero <- unique(rbind(errors_HerbsObs_AgeCl, errors_HerbsObs_Height, errors_HerbsObs_SizeCl))

remove(errors_HerbsObs_AgeCl, errors_HerbsObs_Height, errors_HerbsObs_SizeCl)

if(nrow(errors_HerbsObs_Zero) > 1) {
  errors_HerbsObs_Zero <- errors_HerbsObs_Zero %>%
    filter(Error != "No Error")
} else {
  errors_HerbsObs_Zero <- errors_HerbsObs_Zero}
```

### HerbsObs Errors

```{r}
errors_HerbsObs <- rbind(errors_HerbsObs_Complete, errors_blank, errors_HerbsObs_Header, errors_blank, errors_HerbsObs_Cover, errors_blank,  errors_HerbsObs_Status, errors_blank, errors_HerbsObs_Zero)

remove(errors_HerbsObs_Complete, errors_HerbsObs_Header, errors_HerbsObs_Cover,  errors_HerbsObs_Status, errors_HerbsObs_Zero)
```

```{r}
# Table of results for quick check
#kable(errors_HerbsObs, "pipe")

# Save as CSV or XLSX
path_errors
#write.csv(errors_HerbsObs, paste0(path_errors, "errors_GRCA_FMH_HerbsObs.csv"), quote=FALSE, row.names = FALSE, na = "")
#write_xlsx(errors_HerbsObs, paste0(path_errors, "errors_GRCA_FMH_HerbsObs.xlsx"))
```

# PROTOCOL - HERBS POINTS

This code conducts quality control checks on point line intercept herbaceous data within the "Cover - Points (metric)" data set.

It checks for errors in: height, order, points, status, tape, and transect.

### HerbsPoints Complete

[Problem:]{.underline} Extra of missing data points in FMH plots. There should be 166 rows with Order = 1 for each transect.

[Procedure:]{.underline}

-   Filter by Order = 1. Group by Macroplot, Date, and Transect. Calculate number of hits per plot. Check that sum_hits = 166

```{r}
# Filter NA values. Add number of hits and store in new column
data_temp1 <- HerbsPoints_data %>%
  filter(Order == 1) %>% 
  group_by(MacroPlot.Name, Date, Transect) %>% 
  dplyr::summarize("sum_hits" = n())

data_temp2 <- HerbsPoints_header %>% 
  group_by(MacroPlot.Name, Date) %>% 
  dplyr::summarise()

data_temp_transects <- as.data.frame(1:2)
colnames(data_temp_transects) <- "Transect"
data_temp2 <- merge(data_temp2, data_temp_transects) %>% 
  arrange(MacroPlot.Name, Date, Transect)

data_temp <- merge(data_temp1, data_temp2, by = c("MacroPlot.Name","Date", "Transect"), all = TRUE)
data_temp$sum_hits[is.na(data_temp$sum_hits)] <- 0
remove(data_temp1, data_temp2, data_temp_transects)

# Set parameters 
data <- merge(HerbsPoints_data, data_temp, by = c("MacroPlot.Name", "Date", "Transect"), all = T)
query <- "Cvr Pts Complete" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Total Points") 
values_data <- data$sum_hits
values_valid <- 166
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Complete <- qaqc(data, query, query_message, values_check)
```

### HerbsPoints Header

[Problem:]{.underline} Incorrect header information entered.

[Procedure:]{.underline}

-   Check that NumTran = 2

```{r}
# Set parameters 
data <- HerbsPoints_header
query <- "Cvr Pts Header" 
query_message <- paste0("Number of Transects")
values_data <- data$NumTran
values_valid <- 2
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_NumTran <- qaqc(data, query, query_message, values_check)
```

-   Check that TranLen = 49.8 or 50

```{r}
# Set parameters 
data <- HerbsPoints_header
query <- "Cvr Pts Header" 
query_message <- paste0("Transect Length")
values_data <- data$TranLen
values_valid <- c(49.8, 50)
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_TranLen <- qaqc(data, query, query_message, values_check)
```

-   Check that NumPtsTran = 166

```{r}
# Set parameters 
data <- HerbsPoints_header
query <- "Cvr Pts Header" 
query_message <- paste0("Number of Points per Transect")
values_data <- data$NumPtsTran
values_valid <- 166
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_NumPtsTran <- qaqc(data, query, query_message, values_check)
```

-   Check that Offset = 0

```{r}
# Set parameters 
data <- HerbsPoints_header
query <- "Cvr Pts Header" 
query_message <- paste0("Offset")
values_data <- data$Offset
values_valid <- 0
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Offset <- qaqc(data, query, query_message, values_check)
```

-   Check that FieldTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- HerbsPoints_header
data$FieldTeam[is.na(data$FieldTeam)] <- ""
query <- "Cvr Pts Header" 
query_message <- "Collected By"  
values_data <- data$FieldTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_HerbsPoints_FieldTeam <- qaqc(data, query, query_message, values_check)
```

-   Check that EntryTeam is [not]{.underline} blank

```{r}
# Set parameters  
data <- HerbsPoints_header
data$EntryTeam[is.na(data$EntryTeam)] <- ""
query <- "Cvr Pts Header" 
query_message <- "Entered/Verified By"  
values_data <- data$EntryTeam
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_HerbsPoints_EntryTeam <- qaqc(data, query, query_message, values_check)
```

#### Combine Header Errors

```{r}
errors_HerbsPoints_Header <- unique(rbind(errors_HerbsPoints_NumTran, errors_HerbsPoints_TranLen, errors_HerbsPoints_NumPtsTran, errors_HerbsPoints_Offset))

# errors_HerbsPoints_Header <- unique(rbind(errors_HerbsPoints_NumTran, errors_HerbsPoints_TranLen, errors_HerbsPoints_NumPtsTran, errors_HerbsPoints_Offset, errors_HerbsPoints_FieldTeam, errors_HerbsPoints_EntryTeam))

remove(errors_HerbsPoints_NumTran, errors_HerbsPoints_TranLen, errors_HerbsPoints_NumPtsTran, errors_HerbsPoints_Offset, errors_HerbsPoints_FieldTeam, errors_HerbsPoints_EntryTeam)

if(nrow(errors_HerbsPoints_Header) > 1) {
  errors_HerbsPoints_Header <- errors_HerbsPoints_Header %>%
    filter(Error != "No Error")
} else {
  errors_HerbsPoints_Header <- errors_HerbsPoints_Header}
```

### HerbsPoints Height

[Problem:]{.underline} Height measurements entered incorrectly.

[Procedure:]{.underline}

-   Sort by Height. Check that Height ≤ 2

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
   filter(!is.na(Height))
query <- "Cvr Pts Height" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Height")
values_data <- data$Height
values_valid <- 2
values_check <- values_data <= values_valid

# Identify errors
errors_HerbsPoints_Height_Max <- qaqc(data, query, query_message, values_check)
```

-   Sort by Height. Check that Height is measured at 0.05 increments.

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(!is.na(Height))
query <- "Cvr Pts Height" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Precision error. Height")
values_data <- data$Height
values_valid <- c(0.01, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90, 0.95, 1.00, 1.05, 1.10, 1.15, 1.20, 1.25, 1.30, 1.35, 1.40, 1.45, 1.50, 1.55, 1.60, 1.65, 1.70, 1.75, 1.80, 1.85, 1.90, 1.95, 2.00)
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Height_Precision <- qaqc(data, query, query_message, values_check)
```

-   Sort by Order. Filter out substrates. Check that all Order = 1 have Height values.

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Order == 1) %>% 
  filter(Preferred_Lifeform != "Undefined")
data$Height[is.na(data$Height)] <- ""
query <- "Cvr Pts Height" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Height")
values_data <- data$Height
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_HerbsPoints_Height_Order1 <- qaqc(data, query, query_message, values_check)
```

-   Sort by Order. Check that all Order \>1 rows have Height = blank

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
   filter(Order != 1)
data$Height[is.na(data$Height)] <- ""
query <- "Cvr Pts Height" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Height")
values_data <- data$Height
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Height_Order <- qaqc(data, query, query_message, values_check)
```

-   Filter by Substrate. Check that Height = blank

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Preferred_Lifeform == "Undefined")
data$Height[is.na(data$Height)] <- ""
query <- "Cvr Pts Height" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Height")
values_data <- data$Height
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Height_Substrate <- qaqc(data, query, query_message, values_check)
```

#### Combine Height Errors

```{r}
errors_HerbsPoints_Height <- unique(rbind(errors_HerbsPoints_Height_Max, errors_HerbsPoints_Height_Precision, errors_HerbsPoints_Height_Order1, errors_HerbsPoints_Height_Order, errors_HerbsPoints_Height_Substrate))

remove(errors_HerbsPoints_Height_Max, errors_HerbsPoints_Height_Precision, errors_HerbsPoints_Height_Order1, errors_HerbsPoints_Height_Order, errors_HerbsPoints_Height_Substrate)

if(nrow(errors_HerbsPoints_Height) > 1) {
  errors_HerbsPoints_Height <- errors_HerbsPoints_Height %>%
    filter(Error != "No Error")
} else {
  errors_HerbsPoints_Height <- errors_HerbsPoints_Height}
```

### HerbsPoints Order

[Problem:]{.underline} Order numbers entered incorretly.

[Procedure:]{.underline}

-   Check that Order \> 0

```{r}
# Set parameters 
data <- HerbsPoints_data
query <- "Cvr Pts Order" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order")
values_data <- data$Order
values_valid <- 0
values_check <- values_data > values_valid

# Identify errors
errors_HerbsPoints_Order_Number <- qaqc(data, query, query_message, values_check)
```

-   Check for duplicate points across Date, MacroPlot.Name, Transect, Point, [and]{.underline} Order.

```{r}
# Check for tag duplication and store results in new column
data_temp <- HerbsPoints_data %>% 
  get_dupes(Date, MacroPlot.Name, Transect, Point, Order)

# Set parameters 
data <- merge(HerbsPoints_data, data_temp, all.x = T)
data$dupe_count[is.na(data$dupe_count)] <- 0
query <- "Cvr Pts Order" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Duplicates")
values_data <- data$dupe_count
values_valid <- 0
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Order_Duplicate <- qaqc(data, query, query_message, values_check)
```

-   Filter by Substrate. Check that Order = 1

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Preferred_Lifeform == "Undefined")
query <- "Cvr Pts Order" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Order")
values_data <- data$Order
values_valid <- 1
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Order_Substrate <- qaqc(data, query, query_message, values_check)
```

#### Combine Order Errors

```{r}
errors_HerbsPoints_Order <- unique(rbind(errors_HerbsPoints_Order_Number, errors_HerbsPoints_Order_Duplicate, errors_HerbsPoints_Order_Substrate))

remove(errors_HerbsPoints_Order_Number, errors_HerbsPoints_Order_Duplicate, errors_HerbsPoints_Order_Substrate)

if(nrow(errors_HerbsPoints_Order) > 1) {
  errors_HerbsPoints_Order <- errors_HerbsPoints_Order %>%
    filter(Error != "No Error")
} else {
  errors_HerbsPoints_Order <- errors_HerbsPoints_Order}
```

### HerbsPoints Point

[Problem:]{.underline} Incorrect point numbers entered or point number missing.

[Procedure:]{.underline}

-   Check that Point is between 1 and 166

```{r}
# Set parameters 
data <- HerbsPoints_data
query <- "Cvr Pts Point" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Order = ", data$Order, ". ", "Point")
values_data <- data$Point
values_valid <- seq(1, 166, by = 1)
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Point_Number <- qaqc(data, query, query_message, values_check)
```

-   Check that points are not missing

```{r}
# Filter NA values. Add number of hits and store in new column
expected_sum <- 166 * (1 + 166) / 2

data_temp <- HerbsPoints_data %>%
  filter(Order == 1) %>% 
  group_by(MacroPlot.Name, Date, Transect) %>% 
  dplyr::summarize(across(Point, sum))

data_temp <- data_temp %>% 
  mutate(Missing = expected_sum - data_temp$Point) %>% 
  select(!Point)

# Set parameters 
data <- merge(HerbsPoints_data, data_temp, by = c("MacroPlot.Name", "Date", "Transect"), all = T)
query <- "Cvr Pts Point" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Order = 1. Missing Point") 
values_data <- data$Missing
values_valid <- 0
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Point_Missing <- qaqc(data, query, query_message, values_check)
```

#### Combine Point Errors

```{r}
errors_HerbsPoints_Point <- unique(rbind(errors_HerbsPoints_Point_Number, errors_HerbsPoints_Point_Missing))

remove(errors_HerbsPoints_Point_Number, errors_HerbsPoints_Point_Missing)

if(nrow(errors_HerbsPoints_Point) > 1) {
  errors_HerbsPoints_Point <- errors_HerbsPoints_Point %>%
    filter(Error != "No Error")
} else {
  errors_HerbsPoints_Point <- errors_HerbsPoints_Point}
```

### HerbsPoints Status

[Problem:]{.underline} Species do not have an entry for status or have an entry that we don’t use.

[Procedure:]{.underline}

-   Filter for annual herbaceous species. Check that Status = L

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Preferred_Lifeform %in% c("Graminoid", "Grass-like", "Forb/herb", "Nonvascular", "Fern", "Vine"))
query <- "Cvr Pts Status" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Status")
values_data <- data$Status
values_valid <- c("L")
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Status_Annual <- qaqc(data, query, query_message, values_check)
```

-   Filter for perennial shrub/tree species. Check that Status = L or D

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Preferred_Lifeform %in% c("Shrub", "Subshrub", "Tree"))
query <- "Cvr Pts Status" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Status")
values_data <- data$Status
values_valid <- c("L", "D")
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Status_Perennial <- qaqc(data, query, query_message, values_check)
```

-   Filter for substrates. Check that Status = D

```{r}
# Set parameters 
data <- HerbsPoints_data %>% 
  filter(Preferred_Lifeform == "Undefined")
query <- "Cvr Pts Status" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Order = ", data$Order, ". ", "Species = ", data$Species.Symbol, ". ", "Status")
values_data <- data$Status
values_valid <- c("D")
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Status_Substrate <- qaqc(data, query, query_message, values_check)
```

#### Combine Status Errors

```{r}
errors_HerbsPoints_Status <- unique(rbind(errors_HerbsPoints_Status_Annual, errors_HerbsPoints_Status_Perennial, errors_HerbsPoints_Status_Substrate))

remove(errors_HerbsPoints_Status_Annual, errors_HerbsPoints_Status_Perennial, errors_HerbsPoints_Status_Substrate)

if(nrow(errors_HerbsPoints_Status) > 1) {
  errors_HerbsPoints_Status <- errors_HerbsPoints_Status %>%
    filter(Error != "No Error")
} else {
  errors_HerbsPoints_Status <- errors_HerbsPoints_Status}
```

### HerbsPoints Tape

[Problem:]{.underline} Incorrect tape numbers entered or tape number missing.

[Procedure:]{.underline}

-   Check that Tape is between 0.3 and 49.8, at 0.3 increments

```{r}
# Set parameters 
data <- HerbsPoints_data
query <- "Cvr Pts Tape" 
query_message <- paste0("Transect = ", data$Transect, ". ", "Point = ", data$Point, ". ", "Correct Tape Value = ", data$Point * 0.3, "; ", "Tape")
values_data <- data$Tape
values_valid <- c(0.3, 0.6, 0.9, 1.2, 1.5, 1.8, 2.1, 2.4, 2.7, 3.0, 3.3, 3.6, 3.9, 4.2, 4.5, 4.8, 5.1, 5.4, 5.7, 6.0, 6.3, 6.6, 6.9, 7.2, 7.5, 7.8, 8.1, 8.4, 8.7, 9.0, 9.3, 9.6, 9.9, 10.2, 10.5, 10.8, 11.1, 11.4, 11.7, 12.0, 12.3, 12.6, 12.9, 13.2, 13.5, 13.8, 14.1, 14.4, 14.7, 15.0, 15.3, 15.6, 15.9, 16.2, 16.5, 16.8, 17.1, 17.4, 17.7, 18.0, 18.3, 18.6, 18.9, 19.2, 19.5, 19.8, 20.1, 20.4, 20.7, 21.0, 21.3, 21.6, 21.9, 22.2, 22.5, 22.8, 23.1, 23.4, 23.7, 24.0, 24.3, 24.6, 24.9, 25.2, 25.5, 25.8, 26.1, 26.4, 26.7, 27.0, 27.3, 27.6, 27.9, 28.2, 28.5, 28.8, 29.1, 29.4, 29.7, 30.0, 30.3, 30.6, 30.9, 31.2, 31.5, 31.8, 32.1, 32.4, 32.7, 33.0, 33.3, 33.6, 33.9, 34.2, 34.5, 34.8, 35.1, 35.4, 35.7, 36.0, 36.3, 36.6, 36.9, 37.2, 37.5, 37.8, 38.1, 38.4, 38.7, 39.0, 39.3, 39.6, 39.9, 40.2, 40.5, 40.8, 41.1, 41.4, 41.7, 42.0, 42.3, 42.6, 42.9, 43.2, 43.5, 43.8, 44.1, 44.4, 44.7, 45.0, 45.3, 45.6, 45.9, 46.2, 46.5, 46.8, 47.1, 47.4, 47.7, 48.0, 48.3, 48.6, 48.9, 49.2, 49.5, 49.8)
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Tape <- qaqc(data, query, query_message, values_check)
```

### HerbsPoints Transect

[Problem:]{.underline} Incorrect transect numbers entered or transect number missing.

[Procedure:]{.underline}

-   Check that Transect = 1 or 2

```{r}
# Set parameters 
data <- HerbsPoints_data
query <- "Cvr Pts Transect" 
query_message <- paste0("Transect")
values_data <- data$Transect
values_valid <- c(1, 2)
values_check <- values_data %in% values_valid

# Identify errors
errors_HerbsPoints_Transect <- qaqc(data, query, query_message, values_check)
```

### HerbsPoints Zero

[Problem:]{.underline}  Values entered for columns which should be blank.

[Procedure:]{.underline}

-   Check that CanopyLayer = blank

```{r}
# Set parameters
data <- HerbsPoints_data
data$CanopyLayer[is.na(data$CanopyLayer)] <- ""
query <- "Cvr Pts Zero/NA"
query_message <- "Canopy Layer"
values_data <- data$CanopyLayer
values_valid <- ""
values_check <- values_data == values_valid

# Identify errors
errors_HerbsPoints_Zero <- qaqc(data, query, query_message, values_check)
```

### HerbsPoints Errors

```{r}
errors_HerbsPoints <- rbind(errors_HerbsPoints_Complete, errors_blank, errors_HerbsPoints_Header, errors_blank, errors_HerbsPoints_Height, errors_blank, errors_HerbsPoints_Order, errors_blank, errors_HerbsPoints_Point, errors_blank, errors_HerbsPoints_Status, errors_blank, errors_HerbsPoints_Tape, errors_blank, errors_HerbsPoints_Transect, errors_blank, errors_HerbsPoints_Zero)

remove(errors_HerbsPoints_Complete, errors_HerbsPoints_Header, errors_HerbsPoints_Height, errors_HerbsPoints_Order, errors_HerbsPoints_Point, errors_HerbsPoints_Status, errors_HerbsPoints_Tape, errors_HerbsPoints_Transect, errors_HerbsPoints_Zero)
```

# ALL ERRORS

```{r}
# Create protocol separators
errors_blank_Fuels1000 <- data.frame("SavedQuery" = "PROTOCOL - FUEL 1000","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_FuelsDuffLitt <- data.frame("SavedQuery" = "PROTOCOL - FUEL DUFF LITTER","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_FuelsFine <- data.frame("SavedQuery" = "PROTOCOL - FUEL FINE","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_PostBurn <- data.frame("SavedQuery" = "PROTOCOL - POST BURN","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_Trees <- data.frame("SavedQuery" = "PROTOCOL - TREES","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_Seedlings <- data.frame("SavedQuery" = "PROTOCOL - SEEDLINGS","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_Shrubs <- data.frame("SavedQuery" = "PROTOCOL - SHRUBS","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_HerbsObs <- data.frame("SavedQuery" = "PROTOCOL - HERBS OBSERVED","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))

errors_blank_HerbsPoints <- data.frame("SavedQuery" = "PROTOCOL - HERBS POINTS","MacroPlot.Name" = "","Date" = "","Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "") %>% 
  mutate(Date = as.Date(Date))
```

```{r}
# Save to master error list 
# errors_all <- unique(rbind(errors_Fuels1000, errors_FuelsDuffLitt, errors_FuelsFine, errors_PostBurn, errors_Trees, errors_Seedlings, errors_Shrubs, errors_HerbsObs, errors_HerbsPts))

# errors_all <- rbind(errors_Fuels1000, errors_blank, errors_FuelsDuffLitt, errors_blank, errors_FuelsFine, errors_blank, errors_PostBurn, errors_blank, errors_Trees, errors_blank, errors_Seedlings, errors_blank, errors_Shrubs, errors_blank, errors_HerbsObs, errors_blank, errors_HerbsPts)

errors_all <- rbind(errors_blank_Fuels1000, errors_blank, errors_Fuels1000, errors_blank, errors_blank_FuelsDuffLitt, errors_blank, errors_FuelsDuffLitt, errors_blank, errors_blank_FuelsFine, errors_blank, errors_FuelsFine, errors_blank, errors_blank_PostBurn, errors_blank, errors_PostBurn, errors_blank, errors_blank_Trees, errors_blank, errors_Trees, errors_blank, errors_blank_Seedlings, errors_blank, errors_Seedlings, errors_blank, errors_blank_Shrubs, errors_blank, errors_Shrubs, errors_blank, errors_blank_HerbsObs, errors_blank, errors_HerbsObs, errors_blank, errors_blank_HerbsPoints, errors_blank, errors_HerbsPoints)
```

```{r}
# Create conditional formatting rules
data_temp <- as.data.frame(grepl("PBSev", errors_all$SavedQuery, fixed = TRUE) | grepl(" Post", errors_all$SavedQuery, fixed = TRUE))
colnames(data_temp) <- c("Color")
errors_all_cf <- cbind(errors_all, data_temp)

errors_all_cf <- errors_all_cf %>% 
  mutate(Color = ifelse(SavedQuery == "", NA, Color)) %>% 
  mutate(Color = ifelse((grepl("PROTOCOL", errors_all_cf$SavedQuery) == TRUE), "Protocol", Color)) %>% 
  mutate(Color = ifelse(Color == FALSE, "Standard", Color)) %>% 
  mutate(Color = ifelse(Color == TRUE, "Post", Color))

# Add conditional formating to ouput
errors_all <- condformat(errors_all_cf[1:(nrow(errors_all_cf)), 1:8]) %>%
  rule_fill_discrete(columns = 1:7,
                     expression = (errors_all_cf$Color),
                     colours = c("Standard"="#C6E0B4",
                                 "Post"="#FFC000",
                                 "Protocol" = "#969696"),
                     na.value = "#FFFFFF") %>%
  select(!c("Color"))
```

```{r}
# Table of results for quick check
#kable(errors_all, "pipe")

# Save as CSV or XLSX 
path_errors
# write.csv(errors_all, paste0(path_errors, "errors_GRCA_FMH.csv"), quote=FALSE, row.names = FALSE, na = "") 
#write_xlsx(errors_all, paste0(path_errors, "errors_GRCA_FMH.xlsx"))
# condformat2excel(errors_all, paste0(path_errors, "errors_GRCA_FMH_formatted.xlsx"), overwrite_wb = TRUE)
#condformat2excel(errors_all, paste0(path_errors, "errors_GRCA_FMH_formatted.xlsx"), sheet_name = path_errors_name, overwrite_wb = TRUE)
```
