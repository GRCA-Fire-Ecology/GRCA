---
title: "FFI Database Summary"
subtitle: "Grand Canyon"
output: 
  html_document:
    toc: true
    toc-float: true
    code_download: true
date: "2025-03-17"
---

## Purpose

This report summarizes plot work by the Fire Ecology Program. The included tables and enclosed code allow a user to quickly view the overall status of program, park, project, or protocol activities in an FFI admin unit. The code summarizes records in the Macroplot Report and Sample Event Report that can be downloaded via the Utilities menu on the Project Management tab on the FFI Remote App Server.

### Setup

```{r setup, include=FALSE}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warnings = FALSE, message = FALSE)
```

```{r install packages, include=FALSE}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("kableExtra")
```

```{r load packages, include=FALSE}
## Load Packages

# "here" helps you easily find and reference your working directory
library(here)
# "tidyverse" has lots of useful functions for data cleaning
library(tidyverse)
# "kableExtra" is used to produce formatted tables
library(kableExtra)
# library(stringr)
# library(DT)
# library(fs)
```

### Adjust File Paths

```{r import data, include=FALSE}
# Identify working directory
here()

# Load in data.
path_data <- "X:/FFI Data Management/Exports from FFI/GRCA_FMH/metadata/"
path_output <- paste0(here(), "/output/")
path_data <- "D:/Allie/_FireFX/FFI Data Management/Exports from FFI/GRCA_FMH/"
```

### Load Data

```{r load data, include=FALSE}
## Load Data

MacroplotReport_raw <- read.csv(paste0(path_data, "metadata/MacroplotReport.csv"))
SampleEventReport_raw <- read.csv(paste0(path_data, "metadata/SampleEventReport.csv"))
#ProjectUnitReport <- read.csv(paste0(path_data, "metadata/ProjectUnitAssignmentReport.csv"))
```

### Clean Data

```{r}
# standardize Date columns - MacroplotReport
MacroplotReport <- MacroplotReport_raw %>% 
  # separate Date columns into Date and Time columns
  separate(SampleEventDate, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>% 
  separate(DateIn, sep = " ", into = c("DateIn", "DateInTime")) %>% 
  # reformate Date columns
  mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y"),
         DateIn = as.Date(DateIn, "%m/%d/%Y")) %>% 
  # separate Date columns into Year, Month, and Day columns
  separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "SampleEventDate_Month", "SampleEventDate_Day"), remove = FALSE) %>% 
  separate(DateIn, sep = "-", into = c("DateIn_Year", "DateIn_Month", "DateIn_Day"), remove = FALSE) %>% 
  # remove unnecessary columns
  select(!c(SampleEventTime, SampleEventDate_Month, SampleEventDate_Day, 
            DateInTime, DateIn_Month, DateIn_Day))


# standardize Date columns - SampleEventReport
SampleEventReport <- SampleEventReport_raw %>% 
  # separate Date columns into Date and Time columns
  separate(SampleEvent_Date, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>%
  # reformate Date columns
  mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y")) %>% 
  # separate Date columns into Year, Month, and Day columns
  separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "SampleEventDate_Month", "SampleEventDate_Day"), remove = FALSE) %>% 
  # remove unnecessary columns
  select(!c(SampleEventTime, SampleEventDate_Month, SampleEventDate_Day)) %>%
  # make column names match those in MacroplotReport
  mutate(Macroplot = MacroPlot_Name,
         LegacyMonitoringStatus = SampleEvent_LegacyMonitoringStatus,
         MonStatus = MonitoringStatus_Name) %>% 
  relocate(Macroplot, .after = ProjectUnit_Name) %>% 
  relocate(LegacyMonitoringStatus, .after = SampleEventDate_Year) %>% 
  relocate(MonStatus, .after = LegacyMonitoringStatus) %>%
  select(!c(MacroPlot_Name, SampleEvent_LegacyMonitoringStatus, MonitoringStatus_Name))


# Ensure blanks in UV columns are NA
MacroplotReport$UV1[MacroplotReport$UV1==""] <- NA
MacroplotReport$UV2[MacroplotReport$UV2==""] <- NA
MacroplotReport$UV3[MacroplotReport$UV3==""] <- NA
MacroplotReport$UV4[MacroplotReport$UV4==""] <- NA
MacroplotReport$UV5[MacroplotReport$UV5==""] <- NA
MacroplotReport$UV6[MacroplotReport$UV6==""] <- NA
MacroplotReport$UV7[MacroplotReport$UV7==""] <- NA
MacroplotReport$UV8[MacroplotReport$UV8==""] <- NA
```

## Missing Data & Errors

```{r}
MonStatus_Missing_SampleEventReport <- SampleEventReport %>% 
  select(c(Macroplot, SampleEventDate, MonStatus)) %>%
  filter(MonStatus == "") %>% 
  unique()

MonStatus_Missing_MacroplotReport <- MacroplotReport %>% 
  select(c(Macroplot, SampleEventDate, MonStatus, Purpose)) %>% 
  filter(MonStatus == "", Purpose == "") %>% 
  select(!c(Purpose))

Protocols_Missing <- SampleEventReport %>% 
  select(c(Macroplot, SampleEventDate, MonStatus, Protocols, Visited)) %>% 
  filter(Visited == "N") %>% 
  unique()
```

### Add Missing Data (should be done in FFI)

```{r}
# Fill in missing data - MacroplotReport
MonStatus_Missing_MacroplotReport_Macroplot <- MonStatus_Missing_MacroplotReport$Macroplot
MonStatus_Missing_MacroplotReport_SampleEventDate <- MonStatus_Missing_MacroplotReport$SampleEventDate

MacroplotReport <- MacroplotReport %>%
   mutate(MonStatus = ifelse(Macroplot %in% MonStatus_Missing_MacroplotReport_Macroplot & SampleEventDate %in% MonStatus_Missing_MacroplotReport_SampleEventDate, "Pre", MonStatus))
```

```{r}
# some MonStatus values are missing in the Sample Event Report, but present in the Macroplot Report. Find correct values from Macroplot Report and add them to the Sample Event Report
MonStatus_Missing_SampleEventReport_new <- left_join(MacroplotReport, MonStatus_Missing_SampleEventReport, by = c("Macroplot", "SampleEventDate")) %>% 
  filter(!is.na(SampleEventDate),
         !is.na(MonStatus.y)) %>% 
  mutate(MonStatus_MacroplotReport = MonStatus.x) %>% 
  select(Macroplot, SampleEventDate, MonStatus_MacroplotReport)

SampleEventReport <- left_join(SampleEventReport, MonStatus_Missing_SampleEventReport_new, by = c("Macroplot", "SampleEventDate")) %>% 
  mutate(MonStatus = ifelse(MonStatus == "", MonStatus_MacroplotReport, MonStatus)) %>% 
  select(!MonStatus_MacroplotReport)
```

```{r}
# make sure there are no differences
MonStatus_SampleEventReport <- SampleEventReport %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  unique()

MonStatus_MacroplotReport <- MacroplotReport %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  filter(!is.na(SampleEventDate)) %>% 
  unique()

diff <- setdiff(MonStatus_SampleEventReport, MonStatus_MacroplotReport) %>% 
  mutate(Error = TRUE)
```

### MisIsolate Errors to Fix, New Sample Event Report

```{r}
MonStatus_Errors <- left_join(SampleEventReport, diff, by = c("Macroplot", "SampleEventDate", "MonStatus")) %>% 
  filter(Error == TRUE) %>% 
  select(c(ProjectUnit_Name, Macroplot, SampleEventDate, MonStatus, Error)) %>% 
  unique()

SampleEventReport <- left_join(SampleEventReport, MonStatus_Errors, by = c("ProjectUnit_Name", "Macroplot", "SampleEventDate", "MonStatus")) %>% 
  filter(is.na(Error)) %>% 
  select(!Error)
```

## Macroplot Report

### Sample Events

```{r}
MacroplotReport_SampleEvents <- MacroplotReport %>% 
  select(c("Macroplot", "SampleEventDate", "SampleEventTeam", "SampleEventComment", "MonStatusOrd", "LegacyMonStatus", "MonStatus")) %>%
  filter(!is.na(MonStatusOrd))
```

### Monitoring Status

```{r}
MacroplotReport_MonStatus <- MacroplotReport_SampleEvents %>% 
  select(MonStatus) %>% 
  unique() %>% 
  # extract info based on monitoring status names
  extract(MonStatus, into = c("Entry","Type","TimeSince"),
          regex = "([0-9]+)([A-Z][a-z]+)([0-9]+)", 
          remove = FALSE) %>% 
  # fix up classification of "Year" reads
  mutate(Status = ifelse(Type == "Year", "Post", Type)) %>% 
  relocate(Status, .after = Type) %>% 
  select(!Type) %>% 
  # fix up classifications of "Pre" reads
  mutate(Entry = ifelse(grepl("Pre", MonStatus), 0, Entry),
         Status = ifelse(grepl("Pre", MonStatus), "Pre", Status)) %>% 
  # fix up classifications of "Post" reads
  mutate(Entry = ifelse(grepl("Post", MonStatus), substr(MonStatus, start = 1, stop = 2), Entry),
         Status = ifelse(grepl("Post", MonStatus), "Post", Status),
         TimeSince = ifelse(grepl("Post", MonStatus), 0, TimeSince)) %>% 
  # fix up classifications of "PR" reads
  mutate(Entry = ifelse(grepl("PR", MonStatus), "0", Entry),
         Status = ifelse(grepl("PR", MonStatus), "Pre", Status)) %>%
  # make columns numeric
  mutate(Entry = as.numeric(Entry),
         TimeSince = as.numeric(TimeSince))
```

### Location

```{r}
MacroplotReport_Location <- MacroplotReport %>% 
  select(c("Macroplot", "DateIn", "FutureVisit", "DateOut", "LocatedBy", "Latitude", "Longitude", "UTM_X", "UTM_Y", "UTM_Zone", "Datum", "PDOP", "Precision", "Elevation", "ElevationUnits", "Azimuth", "Aspect", "SlopeHill", "SlopeTransect", "StartPoint", "Directions", "Comments")) %>% 
  filter(!is.na(UTM_Zone))
```

### Purpose

```{r}
MacroplotReport_Purpose <- MacroplotReport %>% 
  select(c("Macroplot", "Purpose", "Type", "MetaData", "UV1")) %>% 
  filter(!is.na(UV1)) 
```

### Disturbance

```{r}
MacroplotReport_Disturbance <- MacroplotReport %>% 
  select(c("Macroplot", "Type", "UV2", "UV3", "UV4", "UV5", "UV6", "UV7", "UV8")) %>% 
  filter(Type != "") %>% 
  select(!Type)
```

#### 01 Disturbance

```{r}
# add add relevant columns
Disturbance01 <- MacroplotReport_Disturbance %>% 
  select(c("Macroplot", "UV2")) %>% 
  filter(!is.na(UV2)) %>% 
  separate(UV2, sep = ": ", into = c("Entry", "Disturbance_Info"), remove = FALSE) %>% 
  separate(Disturbance_Info, sep = ",", into = c("Disturbance_Name", "Disturbance_Type", "Disturbance_Date", "Disturbance_Severity"), remove = FALSE) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  mutate(Entry = 1) %>% 
  select(!c("Disturbance_Info"))

# specific edits
Disturbance01 <- Disturbance01 %>% 
  mutate(Disturbance_Name = ifelse(Macroplot == "SC03", "Tipover East", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "SC03", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "SC03", "12/22/17", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "SC03", "(POST read '18)", Disturbance_Severity)) %>% 
  mutate(Disturbance_Name = ifelse(Macroplot == "SC16", "Tipover East", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "SC16", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "SC16", "12/22/17", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "SC16", "(POST read '18)", Disturbance_Severity)) %>% 
  mutate(Disturbance_Name = ifelse(Macroplot == "PIAB 06", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIAB 06", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIAB 06", "11/9/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIAB 06", "Low Severity", Disturbance_Severity)) %>% 
  mutate(Disturbance_Name = ifelse(Macroplot == "PIAB 24", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIAB 24", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIAB 24", "11/10/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIAB 24", "Moderate/Low Severity", Disturbance_Severity)) %>% 
  mutate(Disturbance_Type = ifelse(Disturbance_Type == "Rx", "RX", Disturbance_Type)) %>% 
  select(!c("UV2"))

# edit date column
Disturbance01 <- Disturbance01 %>% 
  mutate(Disturbance_Date_New = parse_date_time(Disturbance_Date, orders = c("mdy", "my", "y"))) %>% 
  separate(Disturbance_Date_New, sep = "-", into = c("Disturbance_Year", "Month", "Day"), remove = F) %>% 
  select(!c("Month", "Day")) %>% 
  relocate(Disturbance_Date_New, .after = Disturbance_Date) %>%
  relocate(Disturbance_Year, .after = Disturbance_Date_New)
```

#### 02 Disturbance

```{r}
# add add relevant columns
Disturbance02 <- MacroplotReport_Disturbance %>% 
  select(c("Macroplot", "UV3")) %>% 
  filter(!is.na(UV3)) %>% 
  separate(UV3, sep = ": ", into = c("Entry", "Disturbance_Info"), remove = FALSE) %>% 
  separate(Disturbance_Info, sep = ",", into = c("Disturbance_Name", "Disturbance_Type", "Disturbance_Date", "Disturbance_Severity"), remove = FALSE) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  mutate(Entry = 2) %>% 
  select(!c("Disturbance_Info"))

# specific edits
Disturbance02 <- Disturbance02 %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIAB 07", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIAB 07", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIAB 07", "11/10/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIAB 07", "Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIAB 25", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIAB 25", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIAB 25", "11/10/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIAB 25", "Moderate/Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPN 01", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPN 01", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPN 01", "11/10/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPN 01", "Moderate/Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPN 02", "NW 1,3,5", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPN 02", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPN 02", "11/10/2007", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPN 02", "Moderate/Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPO 24", "Watson 2,3,4", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPO 24", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPO 24", "10/14/2011", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPO 24", "Low Severity", Disturbance_Severity)) %>% 
  mutate(Disturbance_Type = ifelse(Disturbance_Type == "Rx", "RX", Disturbance_Type)) %>% 
  select(!c("UV3"))

# edit date column
Disturbance02 <- Disturbance02 %>% 
  mutate(Disturbance_Date_New = parse_date_time(Disturbance_Date, orders = c("mdy", "my", "y"))) %>% 
  separate(Disturbance_Date_New, sep = "-", into = c("Disturbance_Year", "Month", "Day"), remove = F) %>% 
  select(!c("Month", "Day")) %>% 
  relocate(Disturbance_Date_New, .after = Disturbance_Date) %>%
  relocate(Disturbance_Year, .after = Disturbance_Date_New)
```

#### 03 Disturbance

```{r}
# add add relevant columns
Disturbance03 <- MacroplotReport_Disturbance %>% 
  select(c("Macroplot", "UV4")) %>% 
  filter(!is.na(UV4)) %>% 
  separate(UV4, sep = ": ", into = c("Entry", "Disturbance_Info"), remove = FALSE) %>% 
  separate(Disturbance_Info, sep = ",", into = c("Disturbance_Name", "Disturbance_Type", "Disturbance_Date", "Disturbance_Severity"), remove = FALSE) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  mutate(Entry = 3) %>% 
  select(!c("Disturbance_Info"))

# specific edits
Disturbance03 <- Disturbance03 %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPO 17", "Watson 2,3,4", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPO 17", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPO 17", "10/14/2011", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPO 17", "Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPO 20", "Watson 2,3,4", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPO 20", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPO 20", "10/14/2011", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPO 20", "Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPO 21", "Watson 2,3,4", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPO 21", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPO 21", "10/14/2011", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPO 21", "Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Name = ifelse(Macroplot == "PIPO 22", "Watson 2,3,4", Disturbance_Name),
         Disturbance_Type = ifelse(Macroplot == "PIPO 22", "Rx", Disturbance_Type),
         Disturbance_Date = ifelse(Macroplot == "PIPO 22", "10/14/2011", Disturbance_Date),
         Disturbance_Severity = ifelse(Macroplot == "PIPO 22", "Low Severity", Disturbance_Severity)) %>%
  mutate(Disturbance_Type = ifelse(Disturbance_Type == "Rx", "RX", Disturbance_Type)) %>% 
  select(!c("UV4"))

# edit date column
Disturbance03 <- Disturbance03 %>% 
  mutate(Disturbance_Date_New = parse_date_time(Disturbance_Date, orders = c("mdy", "my", "y"))) %>% 
  separate(Disturbance_Date_New, sep = "-", into = c("Disturbance_Year", "Month", "Day"), remove = F) %>% 
  select(!c("Month", "Day")) %>% 
  relocate(Disturbance_Date_New, .after = Disturbance_Date) %>%
  relocate(Disturbance_Year, .after = Disturbance_Date_New)
```

#### 04 Disturbance

```{r}
# add add relevant columns
Disturbance04 <- MacroplotReport_Disturbance %>% 
  select(c("Macroplot", "UV5")) %>% 
  filter(!is.na(UV5)) %>% 
  separate(UV5, sep = ": ", into = c("Entry", "Disturbance_Info"), remove = FALSE) %>% 
  separate(Disturbance_Info, sep = ",", into = c("Disturbance_Name", "Disturbance_Type", "Disturbance_Date", "Disturbance_Severity"), remove = FALSE) %>% 
  mutate(across(where(is.character), str_trim)) %>% 
  mutate(Entry = 4) %>% 
  select(!c("Disturbance_Info", "UV5"))

# edit date column
Disturbance04 <- Disturbance04 %>% 
  mutate(Disturbance_Date_New = parse_date_time(Disturbance_Date, orders = c("mdy", "my", "y"))) %>% 
  separate(Disturbance_Date_New, sep = "-", into = c("Disturbance_Year", "Month", "Day"), remove = F) %>% 
  select(!c("Month", "Day")) %>% 
  relocate(Disturbance_Date_New, .after = Disturbance_Date) %>%
  relocate(Disturbance_Year, .after = Disturbance_Date_New)
```

#### All Disturbances

```{r}
Disturbance <- rbind(Disturbance01, Disturbance02, Disturbance03, Disturbance04)
```

### Merge

```{r}




test <- merge(MacroplotReport_Purpose, MacroplotReport_SampleEvents, by = c("Macroplot"))
test2 <- merge(test, MacroplotReport_MonStatus, by = c("MonStatus"), all = T) %>% 
  relocate(MonStatus, .after = LegacyMonStatus)
test3 <- merge(test2, Disturbance, by = c("Macroplot", "Entry"), all = T) %>% 
  relocate(Entry, .after = MonStatus)

#why diff?
test4 <- test3 %>% 
  select(!c(Disturbance_Name, Disturbance_Type, Disturbance_Date, Disturbance_Date_New, Disturbance_Year, Disturbance_Severity))

diff2 <- setdiff(test4, test2)
```

## Sample Event Report

```{r manipulate data, include=FALSE}
#### Manipulate and add columns to data
## Create column for park via break down of ProjectUnit_Name
#   return all characters to left of either "-" or "_"
#   this won't work for all plot naming schemes but most?

SampGRCA <- SampleEventReport %>% 
  # filter data for only visited plots and unique plot types
  # filter(Visited == "Y",
  #        ProjectUnit_Name %in% c("GRED", "GRIN", "PIAB", "PIED", "PIEN", "PIPN", "PIPO", "RAP_Fawn Spring", "RAP_Hwy 67", "RAP_Moqui", "RAP_Picnic", "RAP_Quarry", "RAP_Range", "RAP_Spring Canyon", "RAP_Thompson", "RAP_Tusayan Pueblo (Thinning)", "RAP_USFS-Burnt Corral", "RAP_USFS-Tipover", "RAP_Walla_Valley")) %>% 
  # remove trailing/leading whitespace
  mutate(across(where(is.character), str_trim)) %>% 
  # add columns
  mutate(PlotType_Name = ifelse(grepl("RAP", ProjectUnit_Name), "RAP", 
                                 ifelse(grepl("GR", ProjectUnit_Name), "Meadow", "FMH"))) %>%
  relocate(PlotType_Name, .after = AdministrationUnit_Name) %>% 
  # separate and reformat Date column
  separate(SampleEvent_Date, sep = " ", into = c("Date", "Time"), remove = FALSE) %>% 
  mutate(Date = as.Date(Date, "%m/%d/%Y")) %>% 
  separate(Date, sep = "-", into = c("Year", "Month", "Day"), remove = FALSE) %>% 
  # remove unneeded columns
  select(!c("Month", "Day", "Time"))


## Create columns for Status (i.e., pre or post), Type of disturbance (i.e., treatment or burn), Entry (i.e. 1st fire, 2nd fire, etc) and Time since disturbance (i.e., Year 1) via break down of the MonitoringStatus_Name field
samp_test <- SampGRCA %>%
  # fill in missing details
  mutate(MonitoringStatus_Name = ifelse(MonitoringStatus_Name == "", "Pre", MonitoringStatus_Name)) %>% 
  mutate(MonitoringStatus_Name = ifelse(MonitoringStatus_Name == "Pre", paste0("00", MonitoringStatus_Name), MonitoringStatus_Name)) %>% 
  # extract info based on monitoring status names
  extract(MonitoringStatus_Name, into = c("Entry","Type","TimeSince"),
          regex = "([0-9]+)([A-Z][a-z]+)([0-9]+)", 
          remove = FALSE) %>% 
  # fix up classification of "Year" reads
  mutate(Status = ifelse(Type == "Year", "Post", Type)) %>% 
  relocate(Status, .after = Type) %>% 
  # make type of disturbance = "burn" for all entries
  mutate(Type = "burn") %>% 
  # fix up classifications of "Pre" reads
  mutate(Entry = ifelse(grepl("Pre", MonitoringStatus_Name), substr(MonitoringStatus_Name, start = 1, stop = 2), Entry),
         Status = ifelse(grepl("Pre", MonitoringStatus_Name), "Pre", Status)) %>% 
  # fix up classifications of "Post" reads
  mutate(Entry = ifelse(grepl("Post", MonitoringStatus_Name), substr(MonitoringStatus_Name, start = 1, stop = 2), Entry),
         Status = ifelse(grepl("Post", MonitoringStatus_Name), "Post", Status),
         TimeSince = ifelse(grepl("Post", MonitoringStatus_Name), 0, TimeSince)) %>% 
  # fix up classifications of "PR" reads
  mutate(Status = ifelse(grepl("PR", MonitoringStatus_Name), "Pre", Status)) %>%
  # make columns numeric
  mutate(Entry = as.numeric(Entry),
         TimeSince = as.numeric(TimeSince))


############
# Should we also change "Type" to reflect plots which have never burned?



## Basic QA/QC of sample event report data
# Check occurrence of remaining NA values
check_NAs <- samp_test %>% 
  summarise(across(everything(), ~ sum(is.na(.x)))) %>% 
  pivot_longer(everything(), names_to = "Count")

# check occurrence of unique values in newly created columns, make corrections as needed
samp_test$PlotType_Name %>% table(exclude = NULL)
samp_test$Status %>% table(exclude = NULL)
samp_test$Type %>% table(exclude = NULL)
samp_test$TimeSince %>% table(exclude = NULL)
```

```{r set parameters, include=F}
### Select Data to Summarize
# use commas to build lists of acceptable values for filters

# designate target park(s)
target_park <- c("GRCA")

# designate target project(s)
# see all project names
unique(SampGRCA$ProjectUnit_Name)
target_project <- c("PIPN")

# designate target year or years
target_year <- c(2024)
```

## Overall Program Summary

The Alaska NPS Fire Ecology program serves all National Parks in Alaska. All data are stored in the FFI database, in an 'Admin Unit' called 'ALASKA'.

```{r program summary}
## Summarise projects and events by park
program_summ <- samp_test %>%
  #group_by(`Park` = Park) %>%
  summarise(`Projects` = n_distinct(ProjectUnit_Name),
            `Number of Plots` = n_distinct(MacroPlot_Name),
            `Monitoring Statuses` = n_distinct(MonitoringStatus_Name),
            `Visit Dates` = n_distinct(SampleEvent_Date),
            `Protocols Used` = n_distinct(Protocols)) %>% 
  ungroup()





## Summarise projects and events by park
program_summ <- samp_test %>%
  summarise(`Projects` = n_distinct(ProjectUnit_Name),
            `Number of Plots` = n_distinct(MacroPlot_Name),
            `Monitoring Statuses` = n_distinct(MonitoringStatus_Name),
            `Visit Dates` = n_distinct(SampleEvent_Date),
            `Protocols Used` = n_distinct(Protocols)) %>% 
  ungroup()

# Calculate totals
program_summ_totals <- program_summ %>%
  summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE))) %>%
  mutate(`Area Program` = "",
         Park = "Total")

# Bind the totals row to the original data frame
program_summ_w_totals <- bind_rows(program_summ, program_summ_totals)

program_summ_w_totals %>% 
  kbl(align = "lcccccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"), 
                full_width = F, position = "left", fixed_thead = T,
                row_label_position = "c") %>% 
  row_spec(0, font_size = 14, bold = TRUE) %>% 
  row_spec(nrow(program_summ_w_totals), font_size = 14, bold = TRUE)
```

## Filtered Summaries

The code underlying this report has been manipulated to display summaries of the following selected park(s), project(s), and year(s).\
\
Selected park(s): [`r target_park`]{style="color:red"}\
Selected project(s): [`r target_project`]{style="color:red"}\
Selected year(s): [`r target_year`]{style="color:red"}\

### Park Summary: `r target_park`

The table below summarizes current and past projects in `r target_park`.

```{r park summ}
## Summarise projects by park
# uses 'target park' variable designated above
target_park_summ <- samp_test %>%
  filter(AdministrationUnit_Name == target_park) %>% 
  group_by(`Project Name` = ProjectUnit_Name) %>%
  summarise(`First Visit` = min(as.numeric(Year)),
            `Latest Visit` = max(as.numeric(Year)),
            `Number of Plots` = n_distinct(MacroPlot_Name),
            `Monitoring Statuses` = n_distinct(MonitoringStatus_Name),
            `Protocols Used` = n_distinct(Protocols)) %>% 
  arrange(desc(`First Visit`)) %>% 
  ungroup() %>% 
  mutate_all(as.character)

# Calculate totals
target_park_summ_totals <- target_park_summ %>%
  summarise(`Number of Plots` = sum(as.numeric(`Number of Plots`))) %>% 
  mutate(`Project Name` = "",
         `First Visit` = "",
         `Latest Visit` = "Total",
         `Monitoring Statuses` = "",
         `Protocols Used` = "") %>% 
  mutate_all(as.character)

# Bind the totals row to the original data frame
target_park_summ_w_totals <- bind_rows(target_park_summ, target_park_summ_totals)
  
target_park_summ_w_totals %>% 
  kbl(align = "lccccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"), 
                full_width = F, position = "left", fixed_thead = T) %>% 
  row_spec(0, font_size = 14, bold = TRUE) %>% 
  row_spec(nrow(program_summ_w_totals), font_size = 14, bold = TRUE)
```

### Project Summary: `r target_project`

The table below summarizes sample events recorded within the `r target_project` project.

```{r project summ}
## Summarise project
# uses 'target project' variable designated above
target_project_summ <- samp_test %>%
  filter(ProjectUnit_Name == target_project) %>% 
  group_by(`Monitoring Status` = MonitoringStatus_Name) %>%
  summarise(`First Visit` = as.Date(min(SampleEvent_Date), format = "%m/%d/%y"),
            `Latest Visit` = as.Date(max(SampleEvent_Date), format = "%m/%d/%y"),
            `Number of Plots Visited in Monitoring Status` = n_distinct(MacroPlot_Name),
            `Protocols Used during Monitoring Status` = n_distinct(Protocols)) %>% 
  arrange(`First Visit`)

target_project_summ %>% 
  kbl(align = "lcccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"), 
                full_width = F, position = "left", fixed_thead = T) %>% 
  row_spec(0, font_size = 14, bold = TRUE)
```

### Plot Activity Summary: `r target_year`

The table below summarizes all projects with plots sampled within the following year(s): `r target_year`.

```{r year summ}
## Summarise yearly plot activity
# uses 'target year' variable designated above
target_year_summ <- samp_test %>%
  filter(Year %in% target_year) %>% 
  group_by(`Project Name` = ProjectUnit_Name) %>%
  summarise(`Start Date` = as.character(as.Date(min(SampleEvent_Date), format = "%m/%d/%y")),
            `End Date` = as.character(as.Date(max(SampleEvent_Date), format = "%m/%d/%y")),
            `Number of Plots` = n_distinct(MacroPlot_Name),
            `Protocols Used` = n_distinct(Protocols)) %>% 
  arrange(`Start Date`) %>% 
  ungroup()

# Calculate totals
year_summ_totals <- target_year_summ %>%
  summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE))) %>%
  mutate(`Project Name` = "",
         `Start Date` = "",
         `End Date` = "Total")

# Bind the totals row to the original data frame
target_year_summ_w_totals <- bind_rows(target_year_summ, year_summ_totals)

target_year_summ_w_totals %>% 
  kbl(align = "lcccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"), 
                full_width = F, position = "left", fixed_thead = T) %>% 
  row_spec(0, font_size = 14, bold = TRUE) %>% 
  row_spec(nrow(target_year_summ_w_totals), font_size = 14, bold = TRUE)
```

## Protocol Use Summary

The table below summarizes the frequency of use of protocols occurring in the FFI database, as utilized by the NPS Alaska Fire Ecology program. Protocols are arranged in descending order by number of plots such that the most frequently used protocols are listed first.

```{r protocol summ}
## Summarise protocol use by status
protocol_use_summ <- samp_test %>%
  group_by(`Protocol` = Protocols) %>%
  summarise(`First Use` = min(as.numeric(Year)),
            `Latest Use` = max(as.numeric(Year)),
            `Number of Plots` = n_distinct(MacroPlot_Name),
            `Number of Projects` = n_distinct(ProjectUnit_Name),
            `Number of Monitoring Statuses` = n_distinct(MonitoringStatus_Name),
            `Number of Parks` = n_distinct(AdministrationUnit_Name)) %>% 
  arrange(desc(`Number of Plots`))

protocol_use_summ %>% 
  kbl(align = "lcccccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"), 
                full_width = F, position = "left", fixed_thead = T) %>% 
  row_spec(0, font_size = 14, bold = TRUE)
```
